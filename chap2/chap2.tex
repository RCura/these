% !TEX root = ../These_Robin_Master.tex
\chapter{Formaliser connaissances et hypothèses, vers un modèle de simulation co-construit : SimFeodal}
\label{chap:chap2}
\begin{center}
	{\large Version \hl{2019-07-08}}
\end{center}

\begin{itemize}
	\item Avril 2019 : Nouveau départ pour le chapitre
	\item 20 Mai 2019 : Reprise commentaires Lena
	\item 28 juin 2019 : Rendu à Lena des reprises de Intro à 2.4 (concepts de modélisation)
	\item 5 Juillet 2019 : Rendu à Lena de 2.4 et 2.5
	\item 8 Juillet 2019 : fin reprise (->2.7.2.3 inclus) + envoi doc à Lena
\end{itemize}
\setcounter{minitocdepth}{1}

	\minitoc


\textbf{Code couleur}
\begin{itemize}
	\item Texte écrit pour cette version du chapitre
	\item {\redroman Texte publié dans le chapitre de Peupler la Terre} (seulement la partie 2.1)
	\item {\blueroman Modifications dans le texte du chapitre de Peupler la Terre} (il n'y en a pas ici)
\end{itemize}

\clearpage

\addcontentsline{toc}{section}{\textit{\textmd{Avant-propos}}}
\begin{mdframed}[backgroundcolor=black!5,footnoteinside=false]
\textbf{\hypertarget{avant-propos}{\textit{Avant-propos}}}

Le présent chapitre décrit un modèle, SimFeodal, qui est une œuvre profondément collective et interdisciplinaire.
La paternité de ce modèle est ainsi à attribuer à l'auteur de ces lignes autant qu'à l'ensemble des co-concepteurs du modèle :
\begin{itemize}
	\item Cécile \textsc{Tannier}, UMR 6049 ThéMA -- Besançon\\
	Géographe et modélisatrice, Directrice de Recherche, CNRS
	\item Samuel \textsc{Leturcq}, UMR 7324 CITERES-LAT -- Tours\\
	Historien, Maître de Conférence, Université François Rabelais
	\item Élisabeth \textsc{Zadora-Rio}, UMR 7324 CITERES-LAT -- Tours\\
	Archéologue, Directrice de Recherche émérite, CNRS
\end{itemize}
Ainsi qu'à ceux qui ont contribué au projet pendant ses premières années :
\begin{itemize}
	\item Élisabeth \textsc{Lorans}, UMR 7324 CITERES-LAT -- Tours\\
	Archéologue, Professeure, Université François-Rabelais
	\item Xavier \textsc{Rodier}, UMR 7324 CITERES-LAT -- Tours\\
	Archéologue, Ingénieur de Recherche HDR, CNRS
\end{itemize}
Ce chapitre de thèse constitue une reprise, individuelle et largement modifiée et retravaillée, d'un chapitre\footnotemark{}~de l'ouvrage collectif \og Peupler la terre\fg{} \autocite{sanders2018peupler} issu du projet TransMonDyn\footnotemark.

\noindent Dans cette thèse, SimFeodal est présenté dans une version différente (v6.3) de celle de l'ouvrage collectif (v4.4), et de nombreux mécanismes sont, par exemple, considérablement simplifiés.
%Les fondements du modèle, toutefois, restent très largement identiques entre ces deux versions, et à ce titre, ce chapitre de thèse reprend parfois des passages entiers du chapitre de l'ouvrage collectif.
%Dans ces moments, nous avons préféré ne pas les identifier en tant que tel, notamment car l'entremêlement de modifications apportées rendrait difficile la lecture.\\
En matière de forme, notons que contrairement au chapitre d'ouvrage et aux parties traitant du modèle dans l'HDR de Cécile \textsc{Tannier} \autocite{tannier_analyse_2017}, le modèle SimFeodal est ici présenté en suivant le protocole de description \og ODD\fg{} (\textit{Overview, Design concepts, and Details}) \autocite{grimm_odd_2010}, dans sa formulation la plus récente (\cite{grimm_documenting_2017}, voir \cref{tab:proto-ODD}).

\noindent SimFeodal ne se prête pas à toutes les catégories identifiées par les auteurs de ce standard, et celui-ci n'est de plus pas pensé pour une description aussi détaillée du modèle.
Nous pensons tout de même que le suivi de ce protocole de description permettra d'accroître la reproductibilité de SimFeodal.
Pour cette même raison, notons que l'implémentation du modèle, son historique ainsi que les différentes descriptions techniques sont disponibles dans le dépôt de versionnement de SimFeodal :
\begin{center}
	\href{https://github.com/SimFeodal/SimFeodal}{https://github.com/SimFeodal/SimFeodal}
\end{center}

\end{mdframed}
\footnotetext[1]{Le chapitre 11, \citetitle{cura_transition_2017}, \autocite{cura_transition_2017}}
\footnotetext[2]{
Projet ANR (ANR-10-BLAN-1805), coordonné par Lena \textsc{Sanders}, entre 2011 et 2014.
\href{www.transmondyn.parisgeo.cnrs.fr}{www.transmondyn.parisgeo.cnrs.fr}
}

\clearpage

\input{chap2/img/tableau-ODD}
\clearpage


\section*{Introduction}
\label{sec:chap2-intro}
\addcontentsline{toc}{section}{Introduction}

Le chapitre précédent (\hl{ref chap 1}) visait à présenter le positionnement de cette thèse, entre géographie, modélisation et informatique.
Ce positionnement, pleinement ancré dans une approche méthodologique plus que thématique, mettait notamment en avant la construction d'une démarche complète de co-construction de modèle.
Le présent ouvrage ne peut s'absoudre de la mise en application de cette démarche, qui sera mobilisée et commentée tout au long des chapitres à venir.
Dans un premier temps, et avant de pouvoir commenter véritablement la méthode de construction, d'évaluation et de paramétrage d'un modèle, il est nécessaire de se doter d'un cas d'étude.
Celui-ci permettra notamment d'illustrer et d'exemplifier, dans les chapitres suivant, les raisonnements et démarches de modélisation qui sont empruntées.
Dans ce chapitre, nous présentons donc de manière détaillée le modèle de simulation auquel notre groupe (voir l'\hyperlink{avant-propos}{avant-propos}) est parvenu à aboutir.

Ce modèle s'intitule SimFeodal, acronyme à peine forcé de \og \textbf{Sim}ulation de la \textbf{F}ixation, de l'\textbf{É}mergence et de l'\textbf{O}rganisation \textbf{D}ynamique d'\textbf{A}grégats de population \textbf{L}ocalisés\fg{}.
Nous reviendrons dans les pages suivantes sur les objectifs poursuivis par la réalisation de ce modèle.

Dans un premier temps, on peut toutefois adresser une remarque au lecteur qui nous semble importante pour la compréhension de ce chapitre : SimFeodal est le résultat d'une expérience, innovante, de modélisation collaborative en contexte interdisciplinaire.
Le processus de modélisation poursuivi est très fortement exploratoire, et n'a en aucun cas été prévisible ou linéaire tout au long des plus de 6 ans de conception.
La seule ligne directrice, relative aux concepts de modélisation, qui a été tenue durant ces années est la volonté d'inscrire la modélisation des phénomènes spatio-temporels considérés dans une approche descriptive, respectueuse du niveau de généralisation auquel consentaient les thématiciens du groupe.
Ces choix ancrent SimFeodal dans une approche \og KIDS\fg{} \autocite{edmonds_kiss_2005}, caractérisée par une modélisation initialement détaillée, que l'on cherche à rendre plus parcimonieuse seulement dans un second temps (\hl{voir chapitre 1}).
Ce type de modélisation permet de ne brusquer aucun des co-concepteurs du modèle, en épargnant en particulier aux experts thématiciens de mener des généralisations hâtives, sans ancrages empirique, qui ne peuvent que contribuer à déposséder un modélisateur des résultats de son modèle.

Il résulte de cette démarche exploratoire un modèle fonctionnel et satisfaisant du point de vue de ses concepteurs : on reviendra dans le \hl{chapitre 7} sur les réponses qu'il a apportées d'un point de vue thématique.
Ce modèle est toutefois assez peu traditionnel, ou en tout cas satisfaisant d'un point de vue de la modélisation épurée et parcimonieuse : les différentes parties qui le constituent (agents, initialisation, mécanismes, sorties\ldots) sont en effet caractérisées par une forte hétérogénéité dans le niveau de généralisation.
Il serait ainsi plutôt nécessaire de parler de niveaux de généralisation, au pluriel donc, tant ceux-ci peuvent varier.

Au delà de la combinaison de démarches incrémentales et itératives (\hl{penser à reprendre l'encadré fait pour le chapitre ISTE du manuel de Denise, peut-être dans le chapitre 1 ou 3}) qui rend difficile la formation d'un produit fini entièrement homogène, il faut noter un aspect important de SimFeodal : ce modèle existe et évolue depuis des années.
C'est vrai aussi bien que l'on prenne en considération le modèle conceptuel ( entrepris il y a plus de 8 ans, en 2011, sans l'auteur de cette thèse), que le modèle implémenté, dont le premier \textit{commit}, c'est-à-dire la première version fonctionnelle, remonte au mois d'avril 2014\footnote{
\href{https://github.com/SimFeodal/SimFeodal/commit/a85598682cda2350b08ea789b966e613dacb1b05}{https://github.com/SimFeodal/SimFeodal/commit/a8559868}}.
On présente, dans ce chapitre, la version \og 6.3\fg{} du modèle, ce qui donne une idée du nombre d'itérations et de modifications de SimFeodal depuis l'établissement des mécanismes d'ensemble qui marquent le début de son existence.

En conclusion de cette introduction, et avant de reprendre le fil de la description de SimFeodal en suivant le protocole ODD, on notera que cette version 6.3 n'est vraisemblablement pas la dernière.
SimFeodal a une existence propre, au sein du groupe de travail présenté dans l'\hyperlink{avant-propos}{avant-propos}, qui dépasse fortement celle de la présente thèse.
Que le lecteur ne s'étonne donc pas de trouver des descriptions différentes de ce modèle, qu'elles soient antérieures ou postérieures au présent ouvrage.
On ne présente ici qu'un état, très temporaire, de ce projet de longue haleine qu'est la co-construction de SimFeodal.


\let\orisectionmark\sectionmark
\renewcommand\sectionmark[1]{}%
\section[Objectifs du modèle SimFeodal -- \textit{Purpose}]{Objectif du modèle SimFeodal -- \large{\textit{Purpose}}}
\orisectionmark{Objectifs}
\let\sectionmark\orisectionmark



\subsection{Contexte historiographique \label{subsec:contexte-historio}}

{\redroman
	La question de l'émergence de la société féodale en Occident est au cœur d'un débat historique ancien.
	Depuis le XVIIIe siècle, les penseurs cherchent à comprendre le fonctionnement de la société médiévale et à cerner ses fondements.
	Les archives sont continûment explorées pour comprendre isolément et précisément les multiples facteurs à l'œuvre dans les processus qui ont fait émerger une société dite \og féodale\fg{} dans le courant des Xe-XIe siècles.
	Cette compréhension se heurte toutefois à la très grande complexité de ces processus, qui peuvent varier chronologiquement, mais aussi présenter des nuances infinies en fonction des zones étudiées.
	Ces difficultés sont encore amplifiées par l'accès aux données, très variable selon l'état de la documentation, soumise aux aléas de la conservation ; d'une manière générale, les historiens des temps féodaux travaillent sur des documents rares et lacunaires, vestiges d'une société fondamentalement portée par l'oralité.
	
	Depuis une quarantaine d'années, l'afflux massif de données de fouilles issues du développement de l'archéologie préventive a permis de renouveler et enrichir ces débats.
	Les sources textuelles, qui apportent un éclairage plutôt normatif de la société, peuvent désormais être confrontées à des sources matérielles propres à mieux cerner les dimensions pratiques.
	Toutefois, cette complémentarité des approches textuelles et matérielles, loin de simplifier les questionnements portant sur la société féodale, les a encore complexifiés en mettant en évidence des aspects anthropologiques et des différenciations géographiques jusqu'alors sous-estimés.
	Le débat s'en est trouvé vivifié, se focalisant désormais sur la question de l'occupation de l'espace, considéré comme un marqueur efficace des transformations sociales.
	L'émiettement et la dissémination des pouvoirs, dont témoigne la multiplication des châteaux (seigneuries châtelaines), se font concomitamment à l'apparition d'un réseau très structuré d'encadrement religieux (paroissialisation de la société), tandis que se fixe de manière définitive un système de peuplement fondé sur un maillage villageois, cœur d'une vie communautaire active.
	
	C'est autour de l'articulation de ces trois éléments fondamentaux de la société féodale (châteaux, églises paroissiales, villages) que portent aujourd'hui analyses et théories.
	Fixation, polarisation et hiérarchisation des centres de peuplement sont désormais les grands processus sociaux examinés à la loupe pour aborder la société médiévale.
	Les historiens médiévistes analysent l'\og encellulement\fg{} de la société \autocite{fossier_enfance_1982}, pistant d'une part les rôles polarisateurs du château (phénomène d'\textit{incastellamento},  \cite{toubert_les_1973}) et de l'église paroissiale accompagnée de son cimetière, considérés comme points de ralliement des populations paysannes, et d'autre part les manières dont les populations organisent collectivement les espaces de production (terroir villageois) pour assurer une répartition équilibrée des ressources.
	
	Dans ce contexte, la période 800-1100 est habituellement considérée comme une période de transition, durant laquelle la société féodale se structure, certains évoquant la \og révolution de l'an Mil\fg{} \autocite{fossier_enfance_1982}, tandis que d'autres tempèrent en parlant de \og révélation de l'an Mil\fg{} \autocite{barthelemy_societe_1993} (\og révélation\fg{} par l'augmentation en quantité et en qualité de la documentation textuelle).
	Les hypothèses sont ainsi nombreuses, et il est difficile de trancher en faveur de l'une ou l'autre, tant l'articulation des facteurs sociaux, politiques, institutionnels, économiques et culturels est complexe.
}

\subsection{Questionnement}

{\redroman
	Dans le cadre de l'ANR TransMonDyn, l'objectif, pour la transition des années 800-1100, est d'étudier les processus à l'œuvre dans la dynamique de fixation, polarisation et hiérarchisation de l'habitat rural.
	L'approche est résolument géographique ; ce sont les implications spatiales des changements sociaux qui sont au cœur de l'étude.
	La modélisation ne porte pas sur les transformations politiques et sociales elles-mêmes, mais sur leur impact sur le système de peuplement.
	Le cœur du questionnement réside dans l'examen de la combinaison des facteurs ayant permis, entre 800 et 1100, la formation d'agrégats de foyers paysans dans une forme hiérarchisée et durable, polarisés par des châteaux ou des églises.
	Il s'agit d'analyser, par la modélisation et la simulation informatique, les conditions d'émergence du maillage villageois.
}

\let\orisectionmark\sectionmark
\renewcommand\sectionmark[1]{}%
\section[Entités et échelles -- \textit{Entities, state variables, and scales}]{Entités et échelles -- \large{\textit{Entities, state variables, and scales}}}
\orisectionmark{Entités et échelles}
\let\sectionmark\orisectionmark

\vspace{-.5em}
\subsection{Entités \label{subsec:entites}}


%\begin{center}
%\begin{tcolorbox}[breakable,colback=yellow,colframe=yellow,width=\dimexpr.7\textwidth\relax]
%Discussion avec Paul : commencer la description par les agents qui sont le moins \og dépendant\fg{} des autres, mais qui les affecteront : 
%	\begin{itemize}
%		\item Seigneurs (-> zones de prélèvement et chateaux)
%		\item Eglises/paroisses
%		\item FP (-> agregats + poles)
%		\item Agregats
%		\item Poles
%		
%	\end{itemize}
%\end{tcolorbox}
%\end{center}

Dans le modèle SimFeodal, plusieurs types d'agents sont en interaction. Ces agents sont des implémentations informatiques des acteurs et entités identifiées dans le modèle conceptuel qui a donné lieu à SimFeodal (voir \textcite[Tableau 1, \ppno~309--310]{cura_transition_2017}).

\noindent Au cœur du modèle, on retrouve les \textbf{foyers paysans}\footnote{
	Ici, on identifie visuellement les premières mentions des \textbf{agents}, de leurs \textit{attributs} et de leurs \ul{mécanismes}.
}.
Ces agents sont une représentation des familles paysannes médiévales et de leur foyer de résidence.
Dans le modèle, un même foyer paysan peut perdurer de 800 à 1200, tout en changeant potentiellement de foyer de résidence à chaque pas de temps, tous les 20 ans.
Il s'agit donc d'une agentification des trajectoires de migration résidentielles que peuvent traverser les générations successives de paysans d'une famille.
Les foyers paysans sont caractérisés par une \textit{localisation} (leur lieu de résidence à un instant \textit{t}), et par une \textit{satisfaction}.\\
La satisfaction des foyers paysans dépend d'une combinaison de facteurs influant sur leur satisfaction \textit{matérielle}, \textit{religieuse} et relative à leur niveau de \textit{protection} (voir \cref{fig:interactions-agents}-\textbf{B}).

\begin{figure}[H]
	\centering
	\includegraphics[width=\linewidth]{img/agents_interactions.pdf}
	\caption{Interactions des agents : seigneurs (\textbf{A}) et foyers paysans (\textbf{B}).}
	\label{fig:interactions-agents}
\end{figure}

\begin{itemize}
	\item La satisfaction matérielle est fonction des droits dont doit s'acquitter un foyer paysan.
	Ceux-si sont \ul{prélevés} par des \textbf{seigneurs}, au sein de \textbf{zones de prélèvement} qu'ils \ul{créent}.
	Ces zones sont une représentation spatiale des droits dont les seigneurs disposent sur la population : \textit{droits fonciers}, \textit{droits de haute justice}, et \textit{autres droits} (droits banaux, droits de basse justice etc.) (\cref{fig:interactions-agents}-\textbf{A}).
	En prélevant des droits, les seigneurs gagnent de la \textit{puissance}.
	
	\item La satisfaction religieuse dépend de la distance entre les foyers paysans et leur \textbf{église paroissiale} la plus proche (\cref{fig:interactions-agents}-\textbf{B}).
	Ces églises paroissiales sont des \textbf{églises} qui ont acquis des \textit{droits paroissiaux}, ce qui constitue une \ul{promotion} (voir \cref{fig:constitution-agents}).
	Le territoire est maillé par des \textbf{paroisses}, qui constituent le pendant surfacique des églises paroissiales et visent à desservir la population (\cref{fig:constitution-poles-paroisses}-\textbf{B}).
	
	\item La satisfaction de protection représente la capacité de protection des foyers paysans face aux violences de l'époque (guerres, pillages, bandits\ldots).
	Elle est mesurée en fonction de la distance au \textbf{château} le plus proche.
	Ces châteaux sont \ul{construits} par les seigneurs tout au long de la simulation, en fonction de leur puissance.
\end{itemize}

\vspace{-1em}\noindent Plus la satisfaction des foyers paysans est faible, plus forte est la probabilité qu'ils effectuent une \ul{migration} à destination d'un \textbf{pôle d'attraction}  (\cref{fig:interactions-agents}-\textbf{B}), agent composite constitué d'un ou plusieurs attracteurs (\cref{fig:constitution-poles-paroisses}-\textbf{A}).

\begin{figure}[H]
	\centering
	\includegraphics[width=\linewidth]{img/agents_paroisses_poles.pdf}
	\caption{Constitution des pôles d'attraction (\textbf{A}) et des paroisses (\textbf{B})\\
		\textit{Exemple de lecture : un pôle d'attraction est composé de 1 ou plusieurs attracteurs ;
			un attracteur peut être une église paroissiale, un château ou un agrégat contenant une communauté paysanne ;
			un pôle d'attraction est donc composé d'un ou plusieurs de ces agents.}}
	\label{fig:constitution-poles-paroisses}
\end{figure}\vspace{-.5em}
\noindent Les foyers paysans peuvent faire émerger des \textbf{agrégats de population} suite à leurs migrations: ces agrégats sont des agents composites composés d'un ensemble suffisant (5) de foyers paysans situés à proximité les uns des autres (\cref{fig:constitution-agents}).
Les agrégats sont des agents en tant que tel, composite puisque constitués par des foyers paysans, mais toutefois dotés de leurs propres attributs, tel que l'existence en leur sein d'une éventuelle \textit{communauté paysanne}.
L'agrégat n'a pas de pérennité propre: si les foyers paysans qui le composaient migrent ailleurs au pas de temps suivant, l'agrégat ne perdurera pas.

\noindent Le \cref{tab:agents-simfeodal} résume les propriétés et caractéristiques des différents agents de SimFeodal.

\begin{figure}[H]
	\centering
	\includegraphics[width=\linewidth]{img/agents_constitution.pdf}
	\caption{Héritages et compositions des agents de SimFeodal.\\
		\textit{Exemple de lecture : un agrégat est composé de 5 ou plus foyers paysans,\\
			un foyer paysan appartient à 0 ou 1 agrégat.}}
	\label{fig:constitution-agents}
\end{figure}

%Ces agents mobiles répondent à des mécanismes d'agrégation et de migration en fonction de leurs niveaux de \textit{satisfactions}, sur les plans matériel, spirituel et en terme de protection face aux violences.
%Les satisfactions sont mesurées respectivement en fonction des droits prélevés par des \textbf{Seigneurs} au sein de \textbf{Zones de Prélèvements} (satisfaction matérielle) ; en fonction de leur distance aux \textbf{églises paroissiales} les plus proches (satisfaction religieuse) ; et en fonction de leur distance aux \textbf{châteaux} -- construits par les \textbf{Seigneurs} -- les plus proches (satisfaction protection).
%Un niveau de satisfaction trop faible pousse les Foyers Paysans à migrer, soit dans un rayon local soit de manière globale.
%Lors de ces migrations, les Foyers Paysans sont attirés par des \textbf{Pôles}, ensembles composites d'\textbf{Attracteurs} (\textbf{châteaux}, \textbf{églises paroissiales} et \textbf{agrégats} de population) qui jouent un rôle de fixation de la population.
%Plus l'attractivité de ces pôles est importante, plus grandes sont leur chance d'attirer suffisamment de Foyers Paysans pour que ces derniers forment des \textbf{Agrégats} de population.
%Cela leur apportera alors un surcroît de satisfaction et permettront de fixer les Foyers Paysans présents et d'en attirer de nouveaux pour faire émerger une hiérarchie dans le système de peuplement.
%Le \cref{tab:agents-simfeodal} résume les propriétés et caractéristiques de ces différents types d'agents.

\input{chap2/img/tableau-agents}
\clearpage
\subsection{Échelles spatiales et temporelles}

\subsubsection{Résolution et échelle spatiale \label{subsec:reso-spatiale}}

SimFeodal prend appui sur un monde théorique \textbf{isotrope}, \textbf{continu}, symbolisé sous la forme d'un \textbf{carré de 80 km de côté}, strictement \textbf{endogène} au modèle.

\paragraph[Isotrope]{} Le monde est \textbf{isotrope} car il ne présente aucune hétérogénéité de surface ou de topologie: la distance entre deux points est mesurée de manière euclidienne.
Cet espace support se veut ainsi le plus neutre et générique possible.
Il est ainsi susceptible de représenter un cas très général, qui peut servir de support à toute la diversité des espaces de l'Europe du Nord-Ouest, par l'entremise de ce dessin théorique.

\paragraph[Continu]{}Contrairement à un usage classique en simulation à base d'agents, nous avons aussi fait le choix de placer SimFeodal dans \textbf{un espace continu}, c'est-à-dire non discrétisé.
La discrétisation de l'espace, sous forme de \og patchs\fg{} ou de \og cellules\fg{}, s'inscrit souvent dans l'héritage des modèles à base d'automates cellulaires.
Les \textit{patchs} prennent d'ordinaire la forme d'agents : cela facilite l'attribution de caractéristiques, comme un certain niveau de ressource, une altitude, une population agrégée etc.
Dans le cas de SimFeodal, l'espace n'est qu'un support: il ne possède aucune caractéristique propre, et de par sa nature isotropique, il n'est pas utile d'y d'éventuelles cellules les unes des autres.
Une large part des mécanismes de SimFeodal s'appuie sur la prise en compte de distances entre agents, à partir de seuils dont les ordres de grandeurs peuvent être très variables (de la centaine de mètres à plus de 10 km).
Nous avons donc préféré conserver une marge de manœuvre élargie en ne procédant pas à une discrétisation de l'espace.

\paragraph[Dimension]{}L'espace est formalisé sous la forme d'\textbf{un carré de 80 km de côté}.
Le choix du carré s'inscrit dans la volonté d'isotropie, et l'espace ainsi défini est proche de l'ordre de grandeur des diocèses médiévaux.
Dans des versions précédentes de SimFeodal, le carré avait un côté de 100 km. Nous avons choisi de le réduire afin d'approcher de la superficie de la Touraine médiévale sur laquelle nous prenons appui pour le calibrage du modèle. 
La superficie du département d'Indre-et-Loire actuel, ou encore du diocèse de Tours, sont ainsi d'environ 6 000 km².
En choisissant un espace support de 80 $\times$ 80 km de superficie (6 400 km²), on facilite l'estimation des densités et mesures d'écartements dans le modèle au regard des connaissances empiriques.
Notons enfin que si l'espace support est bien un carré de 80 km de côté, on en retranche en réalité une partie (1 km de chaque côté, voir \cref{fig:espace-simfeodal}) pour définir un espace utile, ou \og espace actif\fg{}.
On s'assure ainsi qu'aucune localisation ne soit située trop proche des limites de l'espace, ce qui pourrait avoir pour effet de produire des \og effets de bords\fg{}, aussi bien informatiques qu'en termes d'anomalies de voisinages.
L'espace actif, utilisable dans le modèle, est alors de 79 $\times$ 79 km, soit 6 084 km².

\input{chap2/img/schema-monde}

\paragraph[Endogène]{} Notons enfin que l'espace est strictement \textbf{endogène} au modèle.
On entend par là que le monde n'est pas résultant d'un \textit{input}\footnote{
	Contrairement à de nombreux modèles géographiques, il n'y a pas de chargement de configurations initiales dans SimFeodal: la génération de l'espace support est un sous-modèle dans le modèle.
} : seul un paramètre, qui régit la taille des côtés, joue sur la géométrie globale de l'espace.
%Il nous semble important de le préciser, en particulier parce que c'est, à notre connaissance, assez inhabituel dans la simulation de données géographiques, mêmes théoriques.
Les agents sont en effet placés, à l'échelle de l'individu, de manière quasi-aléatoire dans l'espace du modèle.
Cet aléa est toutefois contrôlé à l'échelle du système: la structure d'ensemble du peuplement répond à des caractéristiques choisies et paramétrées.
Cette localisation des agents doit répondre à une double contrainte:
\begin{itemize}
	\item Au niveau des agents, la distribution spatiale doit être aléatoire, afin que les différentes situations spatiales générées présentent une large diversité.
	Cette diversité, éprouvée par l'exécution de nombreuses réplications du modèle, doit être garante de la généricité du modèle.
	\item Au niveau global, la structure du système de peuplement généré doit être partiellement configurable, c'est-à-dire répondre à certains paramètres macroscopiques qui agiront non sur la localisation individuelle des agents, mais sur leur concentration ou dispersion dans l'ensemble de l'espace \og actif\fg{}.
\end{itemize}


\subsubsection{Granularité temporelle}

SimFeodal modélise des processus qui se déroulent sur le temps long, et à ce titre, la gestion de la temporalité est importante.
Le modèle inscrit son exécution dans une étendue de \textbf{400 ans}, \textbf{discrétisée} sous la forme de 20 pas de temps de \textbf{20 ans} chacun.

\paragraph[Durée]{} La période d'étude, thématique, s'étend entre 800 après J.-C. et 1100, qui correspondent à des repères temporels entre lesquels on estime que la transition s'est déroulée (\cref{subsec:contexte-historio}).
Pour modéliser ces évolutions, nous avons choisi de commencer à la même date, mais de prolonger l'exécution du modèle d'un siècle, portant l'intervalle modélisé à \textbf{400 ans}, \textbf{de 800 à 1200}\footnote{
	Dans les versions précédentes de SimFeodal, (par exemple dans \textcite{cura_transition_2017} notamment), cette date était fixée à 1160.
	Nous avons choisi de prolonger de 40 ans parce que cela nous permet de comparer l'état final du modèle au début du XIII$^e$ siècle.
	On obtient de plus un nombre de pas de temps plus \og rond\fg{} (20) qu'auparavant (18), ce qui permet par exemple de représenter l'évolution d'une simulation de manière plus régulière.
}.
Prolonger cette date d'observation permet d'analyser le comportement du modèle après la transition observée, à une date où le système est pleinement inscrit dans son régime post-transition (régime 2).
On peut ainsi, entre autre, voir si les processus à l'œuvre subissent bien un ralentissement, marquant par exemple la fin de la féodalité, plutôt qu'un accroissement constant.

\paragraph[Discret]{} Contrairement à la gestion de l'espace, nous avons choisi de modéliser le temps sous forme \textbf{discrète}.
On peut justifier ce choix avec deux raisons principales.
En premier lieu, la transition s'inscrit dans une forte incertitude temporelle. 
Les experts thématiciens peuvent certes s'appuyer sur des dates précises, par exemple pour des années de réformes, mais les processus à l'œuvre s'inscrivent dans une durée floue.
La résolution de ces processus est difficilement réductible à moins d'un demi-siècle, et à peine meilleure pour les éléments matériels.
Une vision continue du temps s'inscrirait ainsi dans une certaine sur-détermination du modèle en rapport aux connaissances thématiques sur lesquelles il s'appuie.
En second lieu, les processus sont modélisés à un niveau de résolution correspondant à celui des \og foyers paysans\fg{}, c'est-à-dire à l'échelle de foyers plus que d'individus.
Les migrations des foyers paysans correspondent empiriquement plutôt à des déplacements qui surviennent à l'échelle temporelle de la génération.
Cela signifie que ces migrations se réalisent en fait quand les descendants d'un foyer sont en âge de s'établir dans une nouvelle localisation.
La prise en compte d'un temps continu impliquerait la mise en place de bien plus de mécanismes probabilistiques, avec des aberrations potentielles plus importantes en termes de trajectoires des agents.

\paragraph[Pas de temps de 20 ans]{} L'inscription thématique du mécanisme de migration oriente le choix de la granularité du modèle.
\textbf{Les pas de temps ont une durée de 20 ans}, ce qui correspond à peu près à la durée d'une génération à l'époque, c'est-à-dire à l'âge auquel les individus sont en mesure de se marier et de fonder un noyau familial différent de celui de leurs ascendants.
Cela correspond aussi à la précision globale que l'on peut avoir sur l'apparition d'éléments matériels tels que les églises, paroisses et châteaux\footnote{
Certains de ces éléments sont connus avec une précision bien supérieure, par exemple quand des textes historiques mentionnent leur création.
Ce n'est toutefois pas généralisé, et la granularité moyenne gravite plutôt autour de 20 à 40 ans.
}.
Dans l'ensemble, au vu des connaissances historiques, ces pas de temps doivent être interprétés comme des repères temporels plus que comme des dates précises. 
Que les premiers châteaux apparaissent en 980 ou en 1000 n'a pas d'importance dans le modèle, tant que cela se déroule avant le milieu du XI$^e$ siècle par exemple.

La \cref{fig:frise-chrono} illustre les processus et événements qui surviennent pendant l'ensemble de cette période.
Elle donne à voir la correspondance floue entre les événements historiques, précis ou non, et leur implémentation dans SimFeodal.
Cette dernière peut ainsi prendre la forme de changements datés (par exemple le début du mécanisme de don de châteaux), ou au contraire de mises en place graduelles de mécanismes (par exemple les gains de droits de haute justice par les grands seigneurs, qui sont progressifs).

\begin{figure}[H]
	\centering
	\includegraphics[width=\linewidth]{img/frise_chrono_tmd.pdf}
	\caption{Frise chronologique des processus historiques observés en Touraine implémentés dans SimFeodal. \hl{Figure issue de Peupler la Terre, à corriger/adapter.}}
	\label{fig:frise-chrono}
\end{figure}



\let\orisectionmark\sectionmark
\renewcommand\sectionmark[1]{}%
\section[Fonctionnement général -- \textit{Process overview and schedulling}]{Fonctionnement général -- \large{\textit{Process overview and schedulling}}\label{sec:fonctionnement-general}}
\orisectionmark{Fonctionnement général}
\let\sectionmark\orisectionmark

SimFeodal est un modèle qui s'inscrit plutôt dans une approche KIDS que KISS (\hl{voir chapitre 1}).
Il est constitué d'une large variété d'agents (\cref{tab:agents-simfeodal}), dotés pour certains de nombreux comportements.
Au total, ce sont près de quarante mécanismes particuliers (ici regroupés en une quinzaine de mécanismes généraux), appelés selon un ordonnancement constant, qui font interagir les agents à chaque pas de temps.
Dans cette partie, nous présentons une synthèse de ces mécanismes, sans entrer dans le détail, algorithmique ou mathématique, de chacun (voir la \cref{sec:meca-specifiques} pour des descriptions plus précises des mécanismes les plus complexes et importants).
Par ailleurs, afin de bien distinguer ce qui relève de l'explication thématique, empirique, et ce qui relève des choix de modélisation, la description des implémentations au sein de SimFeodal sont encadrés en grisé.

\subsection*{Ordonnancement général \label{meca-ordonancement}}

\input{chap2/img/schema-ordonnancement}

\begin{tcolorbox}[breakable,left=0pt,right=0pt,top=0pt,bottom=0pt,
	colback=gray!15,colframe=gray!15,width=\dimexpr\textwidth\relax, 
	enlarge left by=0mm, boxsep=5pt,arc=0pt,outer arc=0pt]
Dans SimFeodal, les mécanismes sont toujours appelés dans le même ordre (voir \cref{fig:ordonnancement}): l'ensemble de l'ordonnancement ne change pas tout au long des 20 pas de temps du modèle.
Certains mécanismes sont toutefois temporaires, c'est-à-dire rendus inactifs en fonction des pas de temps: la construction des châteaux, par exemple, n'est pas possible avant 940.
Jusqu'au pas de temps correspondant, le mécanisme est alors désactivé par un paramètre réglable.
Notons que si les mécanismes suivent un ordre déterminé, ce n'est pas le cas des agents qui y sont associés.
Pour un mécanisme donné, l'ordre d'appel des agents est aléatoire et varie à chaque appel de ce mécanisme.

\paragraph{}
Remarquons que dans le cas des \og mécanismes globaux\fg{} et de certains mécanismes très techniques (mise à jour des agrégats ou des pôles par exemple), la description des mécanismes ne s'appuiera pas sur une description empirique : ce sont des contraintes et choix propres à la description du monde -- et de ses caractéristiques spatiales -- dans lequel les agents interagissent.
\end{tcolorbox}


\subsection{Initialisation \label{meca-init}}

L'initialisation du monde consiste à créer le monde théorique dans lequel les agents vont interagir et à générer ces derniers.

\begin{tcolorbox}[breakable,left=0pt,right=0pt,top=0pt,bottom=0pt,
	colback=gray!15,colframe=gray!15,width=\dimexpr\textwidth\relax, 
	enlarge left by=0mm, boxsep=5pt,arc=0pt,outer arc=0pt]
Pendant cette étape, des foyers paysans sont générés et localisés dans l'espace du modèle.
Comme indiqué dans \cref{subsec:reso-spatiale}, cette localisation des foyers paysans doit répondre à une double contrainte : aléatoire localement, mais contrôlée globalement.
Pour que ces deux contraintes potentiellement contradictoires soient respectées, on distribue une partie des agents dans l'espace par groupes.
La localisation de ces groupes est aléatoire, mais leur propriétés (nombre de foyers paysans par exemple) sont contrôlées (voir (\cref{sec:initialisation}).

Quelques dizaines d'agents sont ainsi localisés de manière agrégée afin de constituer les premiers agrégats de population, de tailles variables (une vingtaine de villages peu peuplés et quelques petites villes plus importantes, correspondant aux agglomérations secondaires antiques).
Lors de l'initialisation sont aussi créés les premiers seigneurs -- grands seigneurs sans portée spatiale et petits seigneurs localisés aléatoirement dans l'espace -- et les zones de prélèvement dans lesquelles ils prélèveront des droits divers.
L'initialisation est enfin l'occasion de créer et de disperser dans l'espace des églises (150).
Parmi celles-ci, quelques-unes (50) se verront dotées de droits paroissiaux.
Ces églises paroissiales constitueront alors le semis autour duquel sera organisé le premier maillage paroissial.
\end{tcolorbox}

\subsection{Variables globales \label{meca-variables}}


\begin{tcolorbox}[breakable,left=0pt,right=0pt,top=0pt,bottom=0pt,
	colback=gray!15,colframe=gray!15,width=\dimexpr\textwidth\relax, 
	enlarge left by=0mm, boxsep=5pt,arc=0pt,outer arc=0pt]
Plusieurs mécanismes de SimFeodal dépendent du temps:
la possibilité, évoquée plus haut, pour les seigneurs de construire un château, mais aussi, entre autre, l'évolution des distances que les foyers paysans sont prêts à parcourir pour se rendre à l'église, ce qui permet de formaliser l'impact des réformes grégoriennes.
La mise en place de mécanismes tributaires de dates nous permet ainsi de représenter des événements exogènes\footnotemark{} au modèle, qui peuvent ainsi servir de déclencheurs ou de catalyseurs à des processus de longue durée.
L'incrémentation de la date et la mise à jour des différentes variables temporelles (si l'année est supérieure à 940, la variable permettant la construction de château passe de l'état faux à l'état vrai par exemple) constituent donc la première étape de chaque nouveau pas de temps.
\end{tcolorbox}
\footnotetext{
	\hl{Lena : il faut trouver un endroit, plus haut dans le chapitre, pour parler d'endogène/exogène.}
}

\subsection{Renouvellement des foyers paysans \label{meca-renouvellement}}

SimFeodal est un modèle qui simule l'évolution d'un système spatial clôt.
On entend par là qu'il n'y a pas d'échange ou d'interaction avec les régions voisines, ce qui constitue une limite forte, par ailleurs fréquente dans la modélisation géographique.
Pourtant, en particulier dans un modèle mettant en place des migrations, il est difficile de s'abstraire du contexte spatial.
Le monde modélisé constitue certes un système en lui-même, mais aussi un système inscrit comme composante d'un système de peuplement plus large (le royaume des Francs, voire l'Europe du Nord-Ouest).

\begin{tcolorbox}[breakable,left=0pt,right=0pt,top=0pt,bottom=0pt,
	colback=gray!15,colframe=gray!15,width=\dimexpr\textwidth\relax, 
	enlarge left by=0mm, boxsep=5pt,arc=0pt,outer arc=0pt]
Nous avons choisi de modéliser les échanges avec l'extérieur par le biais d'un renouvellement partiel des foyers paysans.
A chaque pas de temps, une proportion (5\%) des foyers paysans existant est, à cet effet, supprimée de la simulation, et une quantité équivalente est réinjectée dans l'espace du modèle.
Afin de ne pas bouleverser l'équilibre de l'agrégation, la localisation dans l'espace suit la proportion de foyers paysans dispersés et agrégés :
s'il y avait 90\% de foyers paysans dispersés avant le renouvellent, 90\% des foyers paysans ré-injectés seront localisés aléatoirement dans l'espace du modèle, et les 10\% restant seront placés dans les agrégats existant\footnotemark.
\end{tcolorbox}
\footnotetext{
	Selon un tirage aléatoire pondéré : les agrégats les plus peuplés attireront potentiellement plus de ces nouveaux foyers paysans que les moins peuplés.
	Cette logique d'attachement préférentiel (\hl{retrouver où j'en parle si c'est avant}) permet de modéliser l'attractivité qu'exercerait un agrégat peuplé, potentiellement plus connu, sur des foyers paysans venant de régions voisines.
}

\subsection{Mise à jour du maillage paroissial \label{meca-paroisses}}

Le Moyen Âge voit apparaître un maillage dense, continu dans l'espace, constitué autour d'églises dotées de droits paroissiaux : les paroisses, qui organisent l'ensemble de la vie spirituelle de la population.
Les archéologues ne s'accordent pas sur la date de leur apparition (avant la période étudiée), ni surtout sur le moment où elles constituent un maillage complet (vraisemblablement pendant la période modélisée).
Ils s'accordent cependant sur le rôle de fixation et de stabilisation du territoire qu'elles ont eu \autocite{zadora-rio_paroisses_2008}.
On sait aussi, d'après les traces empiriques, que la répartition des paroisses n'est pas homogène : dans les zones rurales, l'espacement des églises paroissiales est assez important (quelques kilomètres entre deux églises paroissiales), alors que dans les zones urbaines, de nombreuses églises paroissiales peuvent coexister au sein d'une même ville.

\begin{tcolorbox}[breakable,left=0pt,right=0pt,top=0pt,bottom=0pt,
	colback=gray!15,colframe=gray!15,width=\dimexpr\textwidth\relax, 
	enlarge left by=0mm, boxsep=5pt,arc=0pt,outer arc=0pt]
	Dans SimFeodal, le maillage paroissial est schématisé sous la forme d'un diagramme de Voronoï autour des églises paroissiales.
	À chaque pas de temps, on fait apparaitre de nouvelles églises paroissiales, par des mécanismes de promotion ou de création.
	De par la manière dont les diagrammes de Voronoï sont conçus, ils sont fortement sensibles à l'ajout ou à la suppression de points.
	Il est donc nécessaire, à chaque pas de temps, de répéter l'opération de création du diagramme de Voronoï, en repartant d'une situation \og neutre\fg{} où l'on aura détruit tout maillage pré-existant.
	À ce titre, on peut parler de mécanisme de \og mise à jour\fg{} du maillage, qui comprend donc autant la délimitation des paroisses (les mailles) que la création et promotion de nouvelles églises paroissiales.
\end{tcolorbox}
	Le mécanisme de mise à jour du maillage paroissial s'effectue en trois étapes distinctes~:

\begin{itemize}
	\item \textbf{Dessin du maillage}
		\begin{tcolorbox}[breakable,left=0pt,right=0pt,top=0pt,bottom=0pt,
		colback=gray!15,colframe=gray!15,width=\dimexpr0.94\textwidth\relax, 
		enlarge left by=0mm, boxsep=5pt,arc=0pt,outer arc=0pt]
			Dans SimFeodal, le maillage paroissial est calculé et représenté sous la forme d'une partition de Voronoï autour des églises paroissiales.
			On garantit ainsi un pavage complet du territoire.
			Ce pavage sera lâche dans les zones les moins peuplées et dotées de 	moins d'églises paroissiales.
			Dans les zones les plus peuplées, au contraire, il sera plus dense, par exemple dans les zones contenant les agrégats les plus importants.
	\end{tcolorbox}
	
	\item \textbf{Création de paroisses \og urbaines\fg{}} Les agrégats de population sont localisés dans l'espace, et à ce titre, nécessairement inclus dans au moins une paroisse.
	La population que doivent desservir les paroisses dans lesquelles les agrégats sont localisés croît autant que les agrégats eux-mêmes.
	Empiriquement, on sait que plus le nombre de foyers paysans à desservir était important, plus forte était la probabilité de créer une nouvelle paroisse.
	
	\begin{tcolorbox}[breakable,left=0pt,right=0pt,top=0pt,bottom=0pt,
		colback=gray!15,colframe=gray!15,width=\dimexpr0.94\textwidth\relax, 
		enlarge left by=0mm, boxsep=5pt,arc=0pt,outer arc=0pt]
	SimFeodal comprend, pour modéliser cela, un mécanisme de création de paroisses.
	Selon une logique probabiliste, le modèle fait apparaître de nouvelles églises, directement dotées de droits paroissiaux, au sein des agrégats les plus peuplés.
	Plus un agrégat est peuplé, plus il a de probabilités de voir apparaître, en son sein, une nouvelle église paroissiale dédiée à sa desserte.	
	Afin d'éviter l'apparition exponentielle d'églises paroissiales au sein d'un agrégat, cette probabilité est pondérée par le nombre d'églises paroissiales déjà présentes dans l'agrégat.
\end{tcolorbox}
	
	\item \textbf{Promotion de paroisses \og rurales\fg{}} Tout au long de son développement et à mesure de l'importance sociale qu'il acquière, on sait que le maillage paroissial se densifie, pour parvenir en fin de période au maillage quasi-communal qu'on lui connaît désormais.
	Cette densification est observée, empiriquement, partiellement dans les zones denses, mais aussi très largement de manière homogène sur le territoire, notamment dans les zones les moins peuplées, afin de garantir un accès facilité aux sacrements à l'ensemble des foyers paysans.
	
	\begin{tcolorbox}[breakable,left=0pt,right=0pt,top=0pt,bottom=0pt,
		colback=gray!15,colframe=gray!15,width=\dimexpr0.94\textwidth\relax, 
		enlarge left by=0mm, boxsep=5pt,arc=0pt,outer arc=0pt]
	Dans le modèle SimFeodal, quand le nombre de foyers paysans de ces zones peu denses devient malgré tout trop important, on y fait apparaître de nouvelles églises paroissiales.
	Quand c'est possible, ces nouvelles églises paroissiales peuvent s'appuyer sur les églises locales existantes non dotées de droits paroissiaux.
	Quand il n'y a pas d'église non paroissiale à proximité, on construit de nouvelles églises qui deviendront centres paroissiaux.
	Les spécificités de ce mécanisme sont détaillées dans la section dédiée (\cref{sssec:paroisses}).
\end{tcolorbox}
\end{itemize}


%\paragraph{Dessin du maillage} Le maillage paroissial est calculé et représenté sous la forme d'une partition de Voronoï autour des églises paroissiales.
%On garantie ainsi un pavage complet du territoire.
%Ce pavage sera lâche dans les zones les moins peuplées et dotées de moins d'églises paroissiales.
%Dans les zones les plus peuplées, au contraire, il sera plus dense, comme par exemple dans les zones contenant les agrégats les plus importants.

%\paragraph{Création de paroisses \og urbaines\fg{}} Dans les agrégats les plus peuplés, certaines paroisses peuvent être amenées à regrouper des centaines de paroissiens, ce qui ne correspondrait pas aux connaissances empiriques.
%SimFeodal comprend donc un mécanisme de création de paroisses, via la construction d'églises dotées de droits paroissiaux, au sein des agrégats les plus peuplés, selon une logique probabiliste. 
%Plus un agrégat est peuplé, plus il a de probabilités de voir apparaître une nouvelle église paroissiale, dans son étendue, dédiée à sa desserte.
%
%Afin d'éviter l'apparition exponentielle d'églises paroissiales au sein d'un agrégat, cette probabilité est pondérée par le nombre d'églises paroissiales déjà présentes dans l'agrégat.
%Ainsi, là où un agrégat constitué de 1~000 foyers paysans et contenant une unique paroisse aura une probabilité de 50\% de voir apparaitre une nouvelle églises paroissiale, un agrégat constitué de 1~000 foyers paysans mais déjà doté de 2 paroisses n'aura qu'une probabilité de 25\%.

%\paragraph{Promotion de paroisses \og rurales\fg{}} Tout au long de son développement et à mesure de l'importance sociale qu'il acquière, on sait que le maillage paroissial se densifie, pour parvenir en fin de période au maillage quasi-communal qu'on lui connaît désormais.
%Cette densification est observée partiellement dans les zones denses, mais aussi très largement de manière homogène sur le territoire, notamment dans les zones les moins peuplées, afin de garantir un accès facilité aux sacrements à l'ensemble des foyers paysans.
%Dans ces zones, on fait apparaître de nouvelles églises paroissiales, soit par promotion d'églises existantes (non dotées de droits paroissiaux), soit par construction de nouvelles églises qui deviendront centres paroissiaux.
%Le mécanisme de ces créations est complexe, et on le détaille et l'illustre donc, à l'instar du détail des règles de création de paroisses \og urbaines\fg{}, dans la partie du chapitre relative aux spécificités des mécanismes (\cref{sssec:paroisses}).
%Notons simplement que là encore, la promotion ou création d'églises paroissiales en zones peu denses suit une logique de seuil : si une paroisse contient trop de foyers paysans qui en sont suffisamment éloignés (paroisse d'une superficie importante), on tendra à créer une nouvelle église paroissiale plus proche de ces foyers paysans.

\subsection{Détection des Pôles \label{subsec:detection-poles}}

\begin{tcolorbox}[breakable,left=0pt,right=0pt,top=0pt,bottom=0pt,
	colback=gray!15,colframe=gray!15,width=\dimexpr\textwidth\relax, 
	enlarge left by=0mm, boxsep=5pt,arc=0pt,outer arc=0pt]
	
Dans SimFeodal, lorsque les foyers paysans migrent, ils sont attirés par des pôles d'attraction, qui sont des ensembles composites d'agents de type attracteur (voir \cref{subsec:entites} et en particulier la \cref{fig:constitution-poles-paroisses}-\textbf{A}).
Les pôles sont caractérisés par une attractivité, fonction du nombre et du type d'attracteurs qui les composent.
Plus l'attractivité d'un pôle est importante, plus il est susceptible d'attirer des foyers paysans lors de leur phase de migration.
Les pôles jouent un rôle central dans le mécanisme de migration, et leur définition, c'est-à-dire la manière dont ils sont constitués, revêt alors une importance nette.
La logique d'ensemble (voir \cref{sssec:poles} pour le détail) est basée sur le regroupement dans l'espace de plusieurs attracteurs.
Quand plusieurs attracteurs sont suffisamment proches les uns des autres, ils constituent un unique pôle dont l'emprise spatiale et l'attractivité sera affectée par la localisation et les caractéristiques des attracteurs ainsi regroupés.
Ainsi, quand une église paroissiale est située à proximité\footnotemark{} d'un château, et que ce château est à proximité d'un agrégat de population, on définit un pôle comme composé par ces trois éléments, et représenté par l'enveloppe convexe formée par leurs géométries.
Afin de ne pas artificiellement diviser des pôles pré-existants, ou au contraire voir apparaître de nombreux pôles dans un espace restreint, on procède ensuite à une fusion des pôles les plus proches.
\end{tcolorbox}
\footnotetext{
	Cette proximité est configurable par le biais d'un paramètre.
	Dans SimFeodal, on situe ce seuil à 200 mètres en prenant appui sur les espacements, observés empiriquement, entre les entités considérées dans le modèle comme des attracteurs.
}
%On considère par exemple qu'un agrégat, quelle que soit son importance, contient et fait partie d'un unique pôle.
%
%Les valeurs d'attractivité des pôles, relatives à leur composition en attracteurs, ont donné lieu à un important travail de paramétrage (\hl{voir chapitre 4, et particulièrement les étapes $n$--$j$}), et est désormais fixée selon ces principes (\cref{tab:attraction-poles}) :
%
%\begin{table}[H]
%	\centering
%	{\renewcommand{\arraystretch}{1.1}%
%	\begin{tabular}{|l|l|l|}\hline
%		\textbf{Attracteur} & \textbf{Détail} & \textbf{Attractivité} \\ \hline
%		\multirow{2}{*}{Châteaux} & Petit & 0.15 \\
%		& Gros & 0.25 \\ \hline
%		\multirow{4}{*}{Église paroissiale} & 1 & 0.15 \\
%		& 2 & 0.25 \\
%		& 3 & 0.5 \\
%		& 4+ & 0.6 \\ \hline
%		\multicolumn{2}{|l|}{Agrégat (doté d'une communauté)} & 0.15 \\ \hline
%	\end{tabular}}
%\caption{Attractivité ($\in [0,1]$) conférée aux pôles par leurs attracteurs.}
%\label{tab:attraction-poles}
%\end{table}

\subsection{Satisfaction des Foyers Paysans}

La mesure de la satisfaction\footnote{
	Notons que ce terme n'est pas entièrement \og satisfaisant\fg{} puisque la migration des foyers paysans est favorisée par une faible satisfaction : plus la satisfaction est faible, plus forte est la probabilité qu'il entreprenne une migration.
	Le moteur de la migration est une satisfaction insuffisante (qui n'est donc pas un mécontentement ou \og insatisfaction\fg{}), dont l'on retrouve le sens dans le terme anglais \textit{dissatisfaction}.
} des foyers paysans est le principal déterminant du mécanisme de migration, l'un des mécanismes les plus importants de SimFeodal.
Elle qualifie la capacité des foyers paysans à remplir leurs besoins fondamentaux : \og se nourrir\fg{} (satisfaction matérielle) ; \og assurer son salut\fg{} (satisfaction religieuse) ; et \og éviter d'être l'objet de violences\fg{} (satisfaction \og protection\fg{}) \autocite[Tableau 1, \ppno~309]{cura_transition_2017}.
La satisfaction d'ensemble, qui intervient dans la probabilité de migration, est une synthèse numérique de ces trois satisfactions spécifiques.
Ces composantes sont toutes jugées indispensables : elles ne sont pas pondérées, et la plus faible sert de base au calcul de la satisfaction d'ensemble\footnote{
	Les modalités précises de calcul de la satisfaction d'ensemble, ainsi que de ses composantes matérielles, religieuses et de protection, sont détaillées dans la \cref{sssec:satisfaction}.
}.
%, pondérée par l'appartenance à une communauté, laquelle procure un contre-pouvoir face aux différentes pressions subies par les foyers paysans.
%
%Le détail des calculs est donnée dans la partie dédiée (\cref{sssec:satisfaction}), mais on peut toutefois déjà expliciter les choix de modélisation de chacune des composantes de la satisfaction d'ensemble.

\paragraph{Satisfaction matérielle} \noindent 
\begin{tcolorbox}[breakable,left=0pt,right=0pt,top=0pt,bottom=0pt,
	colback=gray!15,colframe=gray!15,width=\dimexpr\textwidth\relax, 
	enlarge left by=0mm, boxsep=5pt,arc=0pt,outer arc=0pt]
Dans SimFeodal, on considère que plus un foyer paysan doit régler de droits, moins il est satisfait.
La satisfaction matérielle est une fonction des différentes redevances dont un foyer paysan doit s'acquitter.
Comme pour la satisfaction générale, notons que l'appartenance ou non à une communauté intervient dans ce calcul.
On estime en effet que les communautés (paysannes, rurales, villageoises\ldots) permettent de constituer une force suffisante pour exercer un véritable contre-pouvoir face à des seigneurs qui seraient trop exigeants.
\end{tcolorbox}

\paragraph{Satisfaction religieuse} \noindent 
Cette propriété représente la capacité d'un foyer paysan à se rendre facilement à l'église pour y assister aux différents sacrements (baptêmes, mariages, eucharistie\ldots) qui rythment la vie spirituelle de l'époque.
Tout au long de la période, la fréquentation de ces offices religieux augmente en fréquence aussi bien qu'en importance sociale, par exemple à l'occasion des réformes grégoriennes.
\begin{tcolorbox}[breakable,left=0pt,right=0pt,top=0pt,bottom=0pt,
	colback=gray!15,colframe=gray!15,width=\dimexpr\textwidth\relax, 
	enlarge left by=0mm, boxsep=5pt,arc=0pt,outer arc=0pt]
Dans SimFeodal, la satisfaction religieuse est modélisée comme une fonction de la distance à l'église paroissiale la plus proche : plus on est éloigné d'une église paroissiale, plus la satisfaction est faible.
La fonction de distance n'est pas continue : elle est bornée par des seuils, maximaux et minimaux, qui permettent de définir ce qui est considéré comme une distance à ne pas dépasser ou au contraire comme une distance garantissant une satisfaction maximale.
Ces seuils de distance évoluent au cours des pas de temps du modèle, devenant plus restrictifs (les distances minimales et maximales diminuent), afin de représenter l'alourdissement des obligations religieuses.
\end{tcolorbox}

\paragraph{Satisfaction \og protection\fg{}} \noindent 
Avec la diminution du pouvoir de l'autorité centrale carolingienne assortie d'un émiettement des pouvoirs locaux, la région d'étude subit un regain de violences militaires.
L'apparition et le développement progressif des châteaux forts en sont des symptômes représentatifs.
Ils assurent une protection à la population en cas de violence, protection qui devient de plus en plus indispensable au cours de la période.\\
\begin{tcolorbox}[breakable,left=0pt,right=0pt,top=0pt,bottom=0pt,
	colback=gray!15,colframe=gray!15,width=\dimexpr\textwidth\relax, 
	enlarge left by=0mm, boxsep=5pt,arc=0pt,outer arc=0pt]
	Dans SimFeodal, de la même manière que la satisfaction religieuse dépend de la distance aux églises, on considère que la satisfaction protection des foyers paysans dépend de la distance au château le plus proche.
	Cette distance est aussi segmentée par des seuils, eux aussi évolutifs au cours du temps de la simulation.
	Le calcul de la satisfaction protection dépend en plus d'un paramètre, le \og besoin de protection\fg{}, qui permet de représenter l'importance du climat de violence, et notamment, la forme de son évolution temporelle.
\end{tcolorbox}

%\paragraph{Satisfaction religieuse}
%La satisfaction religieuse représente la capacité d'un foyer paysan à se rendre facilement à l'église pour y assister aux différents sacrements (baptêmes, mariages, eucharistie\ldots) qui rythment la vie spirituelle de l'époque.
%Dans SimFeodal, cette capacité est modélisée comme une fonction de la distance à l'église paroissiale la plus proche : plus on est éloigné d'une église paroissiale, plus la satisfaction est faible.
%Les seuils de distance définissant le \og loin\fg{} et le \og proche\fg{} évoluent au cours du temps, afin de représenter l'alourdissement des obligations religieuses tout au long de la période, par exemple à l'occasion des réformes grégoriennes.
%
%\paragraph{Satisfaction de \og protection\fg{}}
%Avec la diminution du pouvoir de l'autorité centrale carolingienne assortie d'un émiettement des pouvoirs locaux, la région d'étude subit un regain de violences militaires.
%L'apparition des châteaux forts en est l'un des symptômes représentatifs.
%De la même manière que la satisfaction religieuse dépend de la distance aux églises, on considère dans SimFeodal que la satisfaction \og protection\fg{} des foyers paysans dépend de la distance au château le plus proche.
%Un château assure ainsi une certaine protection à la population.
%Cette protection se montre de plus en plus critique au fur et à mesure de l'avancement de la période et donc du modèle.
%Comme pour la satisfaction religieuse, les seuils de distance évoluent au cours du temps, de même ici que le \og besoin de protection\fg{}, qui permet de renforcer l'augmentation nette du climat de violence au cours de la période.

\subsection{Migration des Foyers Paysans \label{meca-migration}}


Sur l'ensemble de la période considérée, on observe dans les travaux empiriques de \og fréquentes\fg{} relocalisations (relativement au temps long de 400 ans que nous étudions) des résidences des foyers paysans, c'est-à-dire la construction de nouvelles habitations et  et l'abandon des anciennes.
Ces \og migrations\fg{} sont observées aussi bien sur des distances faibles (quelques centaines de mètres, voir kilomètres) que sur des distances longues, les foyers paysans changeant par exemple de région.
Thématiquement, l'hypothèse émise pour expliquer ces migrations est qu'elles résultent de l'insatisfaction des principaux besoins, matériels, spirituels et en d'integrité physique.
En changeant de localisation et éventuellement en s'agrégeant, les foyers paysans espèrent trouver une mode de vie plus clément que celui de la génération précédente, par exemple, dans le cas de l'agrégation, en mettant en commun leurs outils de production et en présentant une contestation collective face à d'éventuelles exactions ou demandes des seigneurs féodaux.


\begin{tcolorbox}[breakable,left=0pt,right=0pt,top=0pt,bottom=0pt,
	colback=gray!15,colframe=gray!15,width=\dimexpr\textwidth\relax, 
	enlarge left by=0mm, boxsep=5pt,arc=0pt,outer arc=0pt]
Dans SimFeodal, une trop faible satisfaction des foyers paysans les poussent à migrer, c'est-à-dire à s'installer dans un nouveau lieu.
Il ne s'agit pas ici de migrations résidentielles, quotidiennes ou saisonnières : ces migrations sont à entendre sur le temps long.
Elles s'appuient d'ailleurs sur une satisfaction qui n'est mesurée qu'à chaque pas de temps du modèle, c'est-à-dire tous les 20 ans.
La satisfaction est alors à comprendre comme un jugement global sur l'adéquation de la localisation d'un foyer à l'issue de 20 ans d'installation.
Il s'agit donc de modéliser le choix de relocalisation qui peut être réalisé tous les 20 ans, ou schématiquement, à chaque nouvelle génération.

En termes de mécanisme, nous considérons que les foyers paysans suffisamment satisfaits ne sont pas amenés à migrer.
On migre quand on est insatisfait, et l'on cherche alors à augmenter sa satisfaction.
L'implémentation de cette logique suit un mécanisme probabiliste, où l'insatisfaction augmente la probabilité de migrer.
Le mécanisme de migration sera détaillé dans la \cref{sssec:migration}.
Il s'agit sans doute du mécnaisme le plus important et impactant du modèle SimFeodal : à ce titre, il a subit de très nombreux changements depuis le début de la conception du modèle, tel qu'illustré dans \hl{le chapitre 4}.

Dans la version de SimFeodal ici présentée (\hl{version 8}), la migration répond à une succession de conditions.
Dans l'ensemble, quand les foyers paysans migrent, c'est nécessairement vers un pôle d'attraction (voir \cref{fig:constitution-poles-paroisses}-A), et si possible un pôle plus attractif que celui dans lequel ils sont localisés.
Cette migration peut prendre deux formes :
\begin{itemize}
	\item une migration \og locale\fg{}, où les foyers paysans cherchent des pôles plus attractifs dans un rayon défini (2~500 mètres) ;
	\item et la migration \og lointaine\fg{}, où au contraire les foyers paysans cherchent un pôle situé au delà du rayon local.
\end{itemize} 

Entre ces deux formes, la migration locale est d'abord privilégiée sur la migration lointaine\footnotemark.
Quand la migration locale n'est pas possible (absence ce pôles locaux, tirages aléatoires insatisfaisants\ldots), alors les foyers paysans envisagent une migration lointaine.
\end{tcolorbox}
\footnotetext{
	Pour une faible part des agents, intitulés \og non mobiles\fg{}, et qui représentent les foyers paysans dépendants, c'est-à-dire qui n'avaient pas l'autorisation de quitter les terres de leurs seigneurs (serfs, esclaves\ldots), seule la migration locale est d'ailleurs possible.
}

\subsection{Gains de droits}

Au fur et mesure de l'avancement de la période, les travaux empiriques montrent que le pouvoir central s'efface et que les ressorts locaux subissent un émiettement important, voyant apparaître de nombreux seigneurs de moindre importance (les chevaliers notamment).
Ces seigneurs gagnent et s'arrogent le prélèvement de nouveaux droits (droits banaux, droits de basse justice etc.), augmentant d'autant la charge fiscale dont doivent s'acquitter les foyers paysans.


\begin{tcolorbox}[breakable,left=0pt,right=0pt,top=0pt,bottom=0pt,
	colback=gray!15,colframe=gray!15,width=\dimexpr\textwidth\relax, 
	enlarge left by=0mm, boxsep=5pt,arc=0pt,outer arc=0pt]
Dans SimFeodal, cela est modélisé sous la forme de l'apparition constante de nouvelles zones de prélèvement par l'intermédiaire desquelles les seigneurs pourront prélever de nouveaux droits (voir \cref{fig:interactions-agents}-A).
Cela peut concerner de nouveaux seigneurs, lors de leur apparition dans l'espace du modèle, ou au contraire se faire au bénéfice de seigneurs plus anciens.
Du point de vue de l'implémentation, ce comportement est formalisé sous la forme d'une probabilité, pour les petits seigneurs, de créer une nouvelle zone de prélèvement autour de leur localisation, à chaque pas de temps.
Ce mécanisme concerne donc uniquement les petits seigneurs.s

Pour les grands seigneurs, le gain de droits est modélisé sous une autre forme.
À partir d'une date donnée, les grands seigneurs ont ainsi la possibilité de prélever des droits de haute justice sur les foyers paysans situés à proximité de leurs châteaux.
Cette possibilité est matérialisée par la création de zones de prélèvement de haute justice, selon un tirage aléatoire dont la probabilité augmente au cours du temps.
\end{tcolorbox}

\subsection{Collecte des droits}

Empiriquement, les seigneurs prélevaient des droits auprès de leurs sujets pour différentes raisons : droits de haute et moyenne justice, sous la forme de taxes universelles dont chacun devait s'acquitter, mais aussi droits d'usages, banaux par exemple, autour de l'utilisation de tel ou tel équipement collectif (le four à pain banal, le moulin\ldots).
Contrairement aux sociétés actuelles, ces droits n'avaient pas nécessairement de matérialité spatiale : deux habitants voisins étaient susceptibles de s'acquitter de droits à des seigneurs très différents.
Cette répartition des droits pouvait être en fonction de l'usage d'un matériel, ou en fonction d'une appartenance familiale (la \og taille\fg{} personnelle) par exemple, sans que la localisation précise n'entre en jeu.

\begin{tcolorbox}[breakable,left=0pt,right=0pt,top=0pt,bottom=0pt,
	colback=gray!15,colframe=gray!15,width=\dimexpr\textwidth\relax, 
	enlarge left by=0mm, boxsep=5pt,arc=0pt,outer arc=0pt]
Dans SimFeodal, on a cependant choisi de modéliser ces droits au travers de représentations géographiques agentifiées de leur emprise spatiale : les zones de prélèvement.
Celles-ci sont de trois types (cf. \cref{fig:interactions-agents}-A \cref{tab:agents-simfeodal}), qui correspondent à trois grandes catégories de droits connus : les droits fonciers ; les droits de haute justice ; et les autres droits, qui regroupent une forte diversité de redevances locales (droits banaux, droits de basse et moyenne justice, droits locaux\ldots).

Chaque droit a ses propres modalités de collecte (voir le détail en \cref{sssec:collecte-droits}).
On peut résumer cela de manière géométrique : les zones de prélèvement sont des cercles de rayon variables, qui se superposent et s'intersectent très largement.
Les seigneurs (propriétaires et gardiens) prélèvent des droits aux foyers paysans situés dans les zones de prélèvement.
Plus ces derniers sont situés dans une région dense en zones de prélèvements, plus ils seront amenés à s'acquitter de nombreux droits, et plus leur satisfaction matérielle sera faible.
Pour les seigneurs, à l'inverse, plus les redevances collectées seront importantes (plus ils posséderont de zone de prélèvement recouvrant de nombreux foyers paysans), plus leur puissance sera importante, ce qui leur permettra notamment de construire des châteaux, gages de renommée et de revenus accrus.
\end{tcolorbox}

\subsection{Dons entre seigneurs \label{meca-dons}}


Historiquement, on connaît la pratique de certains seigneurs consistant à nommer des gestionnaires ou de distribuer des terres à des seigneurs de moindre importance pour s'assurer de leur vassalité.
De nombreuses lignées aristocratiques sont ainsi apparues suite à l'adoubement d'un roturier en tant que chevalier, par exemple pour le remercier de ses services militaires et en faire un allié inféodé.
Dans le système féodal, à travers le don, les seigneurs constituent ainsi de larges réseaux de vassalité, qui leurs procurent prestige, pouvoir économique et puissance militaire.

\begin{tcolorbox}[breakable,left=0pt,right=0pt,top=0pt,bottom=0pt,
	colback=gray!15,colframe=gray!15,width=\dimexpr\textwidth\relax, 
	enlarge left by=0mm, boxsep=5pt,arc=0pt,outer arc=0pt]
	
	Dans SimFeodal, nous représentons ces logiques par un mécanisme de dons entre seigneurs.
	Ce don, que nous nommons \og gardiennage\fg{}, consiste pour un seigneur à donner une partie de ses possessions à un autre seigneur.
	Notons que dans le détail du mécanisme, il s'agit plutôt d'un prêt que d'un don : le seigneur donateur continue à percevoir des recettes sur les éléments donnés en gardiennage\footnotemark.
	Propriétaire initial et gardien s'enrichissent donc simultanément, ce qui permet de modéliser le gain de puissance économique pour le gardien, et de puissance symbolique pour le donateur.
	
	Comme les seigneurs ont alors tout intérêt à donner, le mécanisme de don repose sur une logique probabiliste : à chaque pas de temps, les seigneurs ont une certaine probabilité de donner chacune de leurs possessions qui ne l'auraient pas encore été.
	Ces possessions sont ici représentées par les zones de prélèvement et les châteaux des seigneurs.
	Dans le cas des zones de prélèvement, les seigneurs récipiendaires sont choisis de manière privilégiée dans le voisinage des seigneurs donateurs : on favorise ainsi une transmission locale.
	Pour les châteaux, il n'y a pas de préférence locale, mais seuls des seigneurs de faible importance peuvent être récipiendaires, c'est-à-dire ceux qui ne sont pas déjà châtelains (ie. qui n'ont pas déjà de château en propre ou en garde).
	
	Notons que ces dons n'ont pas d'influence sur la satisfaction des foyers paysans : pour eux, seul un seigneur (le gardien, ou le propriétaire quand la zone n'a pas été confiée en garde) prélève les droits.
	Le mécanisme de collecte n'est donc pas symétrique : du côté des seigneurs, il représente en même temps le gain de puissance économique (pour le gardien) et symbolique (pour le donateur).
	Au contraire, pour les foyers paysans, la collecte ne représente qu'une contrainte économique : seul le prélèvement du gardien (ou propriétaire initial si la zone de prélèvement n'a pas été donnée en gardiennage) influe sur la satisfaction matérielle.
\end{tcolorbox}
\footnotetext{
	Dans le détail, on peut même noter que les recettes des éléments donnés sont supérieures aux droits collectés en propre : en donnant un bien, on considère ainsi qu'il rapporte plus que ce qu'il aurait garanti comme revenu en le conservant pour son unique usage. Cela permet par exemple de formaliser le gain de puissance symbolique obtenu par l'inféodation de seigneurs inférieurs.
	Le tableau des puissances acquises selon le type de collecte (\cref{tab:puissance-droits}) quantifie ce principe.
}

\subsection{Promotion des châteaux}

De nombreux châteaux ont été construits pendant la période étudiée.
Il y avait naturellement une forte hétérogénéité dans leurs dimensions, leur importance stratégique et le degré de protection qu'ils apportaient.


\begin{tcolorbox}[breakable,left=0pt,right=0pt,top=0pt,bottom=0pt,
	colback=gray!15,colframe=gray!15,width=\dimexpr\textwidth\relax, 
	enlarge left by=0mm, boxsep=5pt,arc=0pt,outer arc=0pt]
	Dans SimFeodal, on a choisi de simplifier cette hiérarchie en distinguant deux types de châteaux : les \og petits châteaux\fg{} et les \og gros châteaux\fg{}.
	Les gros châteaux ont un pouvoir d'attraction plus développé (cf. \cref{tab:attraction-poles}), renforçant l'attraction des pôles qu'ils constituent et par là même accroissant la probabilité de voir se développer à proximité des agrégats majeurs.
	Lors de leur création (voir \textit{infra}), les châteaux sont toujours des \og petits châteaux\fg{}.
	Le mécanisme de promotion, probabiliste, permet à un château situé dans un pôle important (c'est-à-dire constitué de plusieurs attracteurs : agrégat, églises paroissiales) de devenir \og gros château\fg{}, et renforce encore l'attrait de ce pôle déjà avantageux.
\end{tcolorbox}

\subsection{Construction de châteaux}

Tout au long de la période, de nouveaux châteaux sont construits et renforcés. C'est l'apparition des \og châteaux forts\fg{}.
Si l'on connaît des châteaux antérieurs à la période étudiée, leur démultiplication survient surtout à partir de la seconde moitié du X$^e$ siècle.
Ils sont surtout construits par les grands seigneurs existants afin de mailler le territoire d'un réseau de protection, même si certains sont aussi l'œuvre de seigneurs de moindre envergure qui se sont enrichis pendant la période en profitant du système féodal.
En Touraine, on considère que la majeure partie des châteaux forts ont été construits entre le X$^e$ et le XIII$^e$ siècle, et que leur production a ensuite fortement ralenti.
Les châteaux sont bâtis en bonne partie dans des villes déjà attractives, même si l'on observe aussi quelques créations dans des espaces peu peuplés, qui tendront alors à le devenir par la suite (les bourgs castraux).

\begin{tcolorbox}[breakable,left=0pt,right=0pt,top=0pt,bottom=0pt,
	colback=gray!15,colframe=gray!15,width=\dimexpr\textwidth\relax, 
	enlarge left by=0mm, boxsep=5pt,arc=0pt,outer arc=0pt]
	
	Dans SimFeodal, on fait apparaître les châteaux de manière endogène, en considérant qu'il n'y en a aucun au début de la période.
	À partir de 940, les seigneurs ont la possibilité de créer des châteaux.
	Cette possibilité est basée sur une probabilité, fonction de la puissance des seigneurs, c'est-à-dire de l'accumulation des redevances perçues à chaque pas de temps.
	Plus la puissance d'un seigneur est importante, plus il a de chances de pouvoir créer un château.
	Pour que les simulations soient comparables entre les différents paramétrages, et en particulier selon le nombre de foyers paysans implémentés dans chaque simulation, on mobilise cette puissance de manière relative : la puissance relative d'un seigneur est le rapport entre sa propre puissance et la somme des puissances de tous les seigneurs.

	Les grands seigneurs, qui perçoivent plus de droits dès le départ de la simulation, sont ainsi favorisés.
	Au fur et à mesure du déroulement de la simulation, certains petits seigneurs peuvent toutefois aussi être favorisés par leurs prélèvements et par les gardiennages reçus.
	Dans de rares cas, ils peuvent alors être amenés à bâtir eux-aussi des châteaux.
	Les règles spécifiques et précises de construction de châteaux sont explicités dans la partie \cref{sssec:constru-chateaux}.
	
	Notons qu'en matière d'ordonnancement, la construction des châteaux a lieu après le calcul de la \og satisfaction protection\fg{} des foyers paysans, de la promotion en gros châteaux, et aussi après le don de ces mêmes châteaux, ce qui pourrait sembler contre-intuitif.
	Ce choix a été fait pour symboliser la durée de construction des châteaux, bien plus longue que les autres phénomènes d'apparition décrits dans le modèle : un château apparaît en fin de tour, il n'est donc pas véritablement utilisable avant le tour suivant, soit 20 ans plus tard.

\end{tcolorbox}



\subsection{Création de nouveaux seigneurs}

L'émiettement des pouvoirs pousse à l'apparition de nombreux seigneurs, majoritairement d'envergure très locale , tout au long de la période.
On estime qu'il y avait une vingtaine de seigneurs en Touraine en début de période et plus de 200 en 1200.
Ces seigneurs sont détenteurs d'un faible pouvoir et ne possèdent généralement pas de terres \og en propre\fg{} : une large proportion tire ses revenus de terres et d'installations dont ils assurent le gardiennage pour leur suzerain, par exemple sous la forme de banalités ou de délégations de moyenne justice.

\begin{tcolorbox}[breakable,left=0pt,right=0pt,top=0pt,bottom=0pt,
	colback=gray!15,colframe=gray!15,width=\dimexpr\textwidth\relax, 
	enlarge left by=0mm, boxsep=5pt,arc=0pt,outer arc=0pt]
Dans SimFeodal, l'accroissement des seigneurs est modélisé sous la forme de l'apparition régulière de nouveaux seigneurs.
À chaque pas de temps, un nombre quasiment constant\footnotemark{} de nouveaux seigneurs est ainsi créé.
Parmi ces seigneurs, seule une faible proportion (10\%) est dotée de terres et collecte donc des droits fonciers.
Les autres seigneurs constituent un vivier potentiel de récipiendaires de dons divers (voir \cref{meca-dons}).
L'ensemble de ces seigneurs sont répartis, spatialement, au sein des agrégats existants lors de leur création.
\end{tcolorbox}
\footnotetext{
Il s'agit d'un nombre aléatoire tiré d'une distribution normale dont l'écart type est très faible au regard de la moyenne.
Cela permet d'avoir un nombre à peu près constant de 200 seigneurs en fin de simulation, après le tirage effectué à chaque pas de temps.
Le faible aléa insuffle toutefois une certaine variabilité qui nous permet de démarquer les simulations.
}

\subsection{Détection des agrégats \label{meca-agregats}}

L'un des constats forts ayant mené à l'identification d'une \og transition\fg{} \autocite{pumain_convergences_2017, nuninger_cadre_2017} dans le système de peuplement de l'Europe du Nord-Ouest est la hiérarchisation du système de peuplement.
Dans ce cadre, on la constate par une concentration de la population dispersée, et par l'apparition de hameaux, villages et petites villes suivant une hiérarchie de population.
L'utilisation de ces termes plus spécifiques est particulièrement sensible en histoire et en archéologie, en particulier en raison d'usages potentiellement anachroniques : certains refusent par exemple l'appellation de villes aux agglomérations secondaires antiques du IX$^e$ siècle.
Nous avons donc choisi de ne pas subdiviser, en termes lexicaux, le continuum des tailles et types d'agglomération de foyers.
On fait usage, dans son sens le plus littéral, du terme \og agrégat\fg{} de population pour désigner l'ensemble de ces concentrations humaines.

\begin{tcolorbox}[breakable,left=0pt,right=0pt,top=0pt,bottom=0pt,
	colback=gray!15,colframe=gray!15,width=\dimexpr\textwidth\relax, 
	enlarge left by=0mm, boxsep=5pt,arc=0pt,outer arc=0pt]
Dans SimFeodal, ces agrégats sont interprétés de manière morphologique, à l'instar des agglomérations de l'INSEE : est agrégat un regroupement d'au moins 5 foyers paysans, espacés l'un à un autre d'au plus 100 mètres.
Cette définition permet de représenter des entités géographiques très diverses, depuis le petit agrégat composé de quelques foyers paysans à l'agrégat majeur, semblable à une petite ville, constitué de plusieurs centaines de foyers.
L'agrégat est une entité spatiale au sens propre, dotée par exemple de ses propres attributs et sa propre emprise spatiale, constituée par l'enveloppe convexe des foyers paysans qui le composent : c'est une entité individuelle mais composite.
\end{tcolorbox}

Certains agrégats peuvent contenir une \og communauté\fg{} (voir \cref{constitution-agents}), c'est-à-dire une structure institutionnalisée gérée par les foyers la composant et qui procure un avantage en matière de rapport de force et de subsistance matérielle (par exemple avec les logiques de gestion collective des terres et outils que permettent les communautés agraires).
\begin{tcolorbox}[breakable,left=0pt,right=0pt,top=0pt,bottom=0pt,
	colback=gray!15,colframe=gray!15,width=\dimexpr\textwidth\relax, 
	enlarge left by=0mm, boxsep=5pt,arc=0pt,outer arc=0pt]
Dans SimFeodal, les agrégats ont une probabilité (20\%), à chaque pas de temps, de voir apparaître une communauté en leur sein.
D'un point de vue informatique, cela complexifie énormément la détection des agrégats : dès lors que des agents ont des propriétés propres, celles-ci doivent être transmissibles dans le temps, c'est-à-dire d'un pas de temps à l'autre.
Pourtant, la détection des agrégats est renouvelée à chaque pas de temps, ce qui signifie qu'un agrégat détecté en 900, situé au même endroit qu'un agrégat de 880, ne peut que difficilement lui être associé\footnotemark.
Le mécanisme spécifique de détection, de constitution et de transmission des attributs des agrégats est donc particulièrement complexe, et fait l'objet d'une présentation détaillée plus loin dans le chapitre (\cref{sssec:agregats}).
\end{tcolorbox}
\footnotetext{
	C'est un problème récurrent des méthodes de \textit{clustering} dynamique que de réussir à mener des associations entre les \textit{clusters} de différentes dates.
}

\subsection{Actualisation des pôles}

\begin{tcolorbox}[breakable,left=0pt,right=0pt,top=0pt,bottom=0pt,
	colback=gray!15,colframe=gray!15,width=\dimexpr\textwidth\relax, 
	enlarge left by=0mm, boxsep=5pt,arc=0pt,outer arc=0pt]
La détection des pôles (\cref{subsec:detection-poles}) intervient relativement tôt dans l'ordonnancement des mécanismes (voir la \cref{fig:ordonnancement} dans la \cref{meca-ordonancement}).
Il est par exemple nécessaire que les pôles soient définis avant le mécanisme de migration des foyers paysans, qui dépend en partie de ces pôles.
Pourtant, en vue de préparer et de sauvegarder les \textit{outputs}, il est nécessaire de redéfinir les pôles, parce que les attracteurs qui les constituent peuvent avoir changé : apparition de nouveaux châteaux, apparition ou disparition d'agrégats contenant une communauté\ldots.

Cela permet par exemple, lors de l'enregistrement des sorties, de conserver un lien entre un agrégat et le pôle dans lequel il se situe, notamment pour étudier les relations entre composition des pôles et populations des agrégats qui y sont attachés.
Dans SimFeodal, nous sommes alors obligés, afin d'avoir des sorties exploitables, de reconstruire les pôles en fin de tour.
Cette duplication d'un mécanisme est malheureuse et peu optimale, mais rendue nécessaire par la structure des différents mécanismes précédents et en particulier par l'interdépendance qui caractérise de nombreux types d'agents dans le modèle.
\end{tcolorbox}


\subsection{Enregistrement des \textit{outputs} \label{meca-outputs}}

\begin{tcolorbox}[breakable,left=0pt,right=0pt,top=0pt,bottom=0pt,
	colback=gray!15,colframe=gray!15,width=\dimexpr\textwidth\relax, 
	enlarge left by=0mm, boxsep=5pt,arc=0pt,outer arc=0pt]
Lors de la conception et du développement de SimFeodal, on a rapidement choisi de mener l'exploration du modèle très largement \textit{a posteriori} (\hl{voir chapitre 5, section 5.2.1}) de l'exécution du modèle.
L'enregistrement des données d'un modèle est un problème complexe, dont les enjeux et difficultés sont largement résumées dans le chapitre 5 (\hl{section 5.1}).
Notons ici, tout de même, que nous avons besoin d'enregistrer des données relatives à l'ensemble des agents, pris individuellement, et à leurs attributs.
Les données produites par la simulation sont par conséquent assez massives et revêtent une importance particulière.
Lors de cette phase, des variables globales et spécifiques sont actualisées, des indicateurs synthétiques sont calculés, et l'ensemble des données subit des traitements voués à en simplifier la conservation, par exemple en réduisant la précision des nombres décimaux\footnotemark.
\end{tcolorbox}

\footnotetext{
	Pour illustrer l'importance de ce traitement d'apparence anecdotique, on peut prendre l'exemple de l'enregistrement des géométries.
	Celles-ci, dans la plate-forme Gama \autocite{taillandier_building_2018} utilisée pour SimFeodal, sont exportées dans un format textuel normalisé, le \og Well-Known Text\fg{} (\textit{WKT}).
	Par défaut, chaque géométrie est décrite avec une précision de 12 chiffres décimaux, soit une résolution spatiale proche du picomètre, l'ordre de grandeur des atomes.
	Cette précision n'a strictement aucune utilité dans un modèle où les ordres de grandeur minimums tournent autour des dizaines et centaines de mètres.
	D'un point de vue informatique, stocker 12 décimales au lieu d'entiers démultiplie considérablement la place nécessaire pour l'enregistrement des données.
	Ces étapes de simplification sont donc indispensables pour disposer d'un modèle fonctionnel et exploitable.
}

\let\orisectionmark\sectionmark
\renewcommand\sectionmark[1]{}%
\section[Concepts de modélisation-- \textit{Design concepts}]{Concepts de modélisation -- \large{\textit{Design concepts}}}
\orisectionmark{Concepts de modélisation}
\let\sectionmark\orisectionmark

Cette section du protocole ODD vise à mettre en avant les concepts courants de la modélisation de systèmes complexes qui sont employés dans le modèle.
Les catégories du protocole ODD\footnote{
\textit{Basic principles}, \textit{emergence}, \textit{adaptation}, \textit{objectives}, \textit{learning}, \textit{prediction}, \textit{sensing}, \textit{interaction}, \textit{stochasticity}, \textit{collectives } et \textit{observation}.
Le détail de ces \og concepts de conception\fg{}, illustré avec des exemples de questionnement, est visible dans la partie 4 du \cref{tab:proto-ODD}, au début de ce chapitre.
} visent à l'exhaustivité, et l'ensemble des concepts décrits ne sont pas nécessairement mobilisés dans SimFeodal.
Par soucis de clarté, on décrira donc d'abord les grands principes de modélisation qui nous semblent fondamentaux dans SimFeodal, et ensuite, le cas échéant, les ensembles de concepts mobilisés.

\subsection{Principes de base - \textit{Basic principles}}

SimFeodal a été pensé en s'appuyant sur trois principes importants qui ont fortement orienté son développement conceptuel autant que son implémentation. On souhaitait ainsi que le modèle (1) s'ancre et s'appuie résolument sur un espace géographique, (2) que l'évolution de la structure spatiale résulte de dynamiques multi-scalaires et (3) que la fixation de cette structure est due à des mécanismes d'auto-renforcement spatial.
Ces principes constituent des choix forts, préalables à l'implémentation en tant que telle, mais qui ont persisté à guider l'ajout et la spécification des mécanismes.
Le profil, thématique et disciplinaire des co-concepteurs de SimFeodal n'est certainement pas étranger à ces choix.
En rassemblant archéologues et géographes modélisateurs dans un projet de modélisation spatiale, le résultat ne pouvait qu'être très influencé par les approches de la géographie systémique et de l'analyse spatiale.


\paragraph{\textit{Space Matters}}

SimFeodal est un modèle intrinsèquement spatial.
De nombreux modèles agents \og mobilisent\fg{} l'espace, c'est-à-dire qu'ils s'appuient sur un espace euclidien pour représenter les interactions et émergences qu'ils décrivent.
Pourtant, dans ces modèles, l'espace n'est souvent qu'un support qui tient lieu de référentiel dans lequel on pourra représenter et visualiser un processus quelconque : on parle d'ailleurs assez peu d'espace, mais le plus souvent de \og monde virtuel\fg{}, ce monde n'étant qu'un contenant des agents modélisés.
Par exemple, on trouve de nombreux modèles de réseaux dans les bibliothèques classiques de modèles agents, où l'espace support est une vue planaire plus qu'un support euclidien ou topographique réel.

Dans SimFeodal, au contraire et comme la brève description des mécanismes le montre, une très large partie des (inter)actions dépendent des distances (modèles de types gravitaires pour le calcul de la satisfaction religieuse et de protection), des contextes spatiaux (évaluation de l'environnement local pour les migrations locales) ou encore des voisinages (constitution d'agrégats, détection des pôles etc.).
SimFeodal n'est donc pas un modèle qui ne ferait que prendre appui sur un espace-contenant.
C'est un modèle dont le fonctionnement inhérent est spatial, voire géographique ou géométrique.
\textit{Space matters}\ldots

\paragraph{Dynamiques multi-scalaires et \textit{Push-Pull}}

L'évolution de la structure spatiale que l'on observe dans SimFeodal résulte de la migration des foyers paysans, qui tendent à se concentrer.
En se concentrant, ils créent des agents de niveau supérieur (les agrégats), qui peuvent alors attirer de nouveaux foyers paysans, directement (attraction des agrégats) ou indirectement (une forte densité de foyers paysans pousse à la création d'églises paroissiales qui attireront alors à leur tour).
La migration des foyers paysans se situe alors à deux échelles : individuellement, les agents migrent selon une échelle macroscopique, mais ils sont attirés par des agents d'échelle mésoscopique.

La mise en place de ce principe de migration est fortement inspirée par et ancrée dans une certaine pratique de modélisation, courante dans le champ des études de mobilité résidentielle, que l'on peut qualifier de \og \textit{push-pull}\fg{} \autocite{tannier_analyse_2017}.
On entend par là que les agents subissent un double mécanisme, répulsif, qui les pousse à déménager (ou migrer dans SimFeodal), le \textit{push}, et attractif, qui conditionne leur choix de destination à l'attractivité d'un lieu, le \textit{pull}.
Ce modèle est d'ordinaire mobilisé dans l'étude de mobilités résidentielle, ou encore vis-à-vis de pratiques quotidiennes de l'espace.
Son application nous semble inédit sur des processus d'une temporalité plus importante, telle que le temps long sur lequel SimFeodal s'appuie.

Si ce choix peut paraître surprenant, il résulte avant tout d'une certaine \og culture de modélisation\fg{}, l'une des co-conceptrices du modèle ayant une forte habitude de modélisation de dynamiques résidentielles (\textit{ibid.}).
En dehors de l'importance de cette \og path-dependency\fg{} d'un modèle aux conceptions préalables de ses modélisateurs, notons tout de même que ce type de modélisation nous semble assez facilitateur de dialogue avec des thématiciens .
Cette vision \og comportementaliste\fg{} et agent-centrée permet peut-être plus simplement que d'autres paradigmes de passer d'une connaissance experte spécifique à une modélisation plus générique.

\paragraph{Auto-renforcement par attachement préférentiel}
L'auto-renforcement est le dernier grand principe sur lequel SimFeodal s'appuie.
Dans le modèle, plus un élément (pôle d'attraction par exemple) est important, plus il va attirer et accroître son importance en retour.
Cette logique est assez proche du principe de rétroaction positive, si ce n'est qu'il ne s'agit ici que de renforcer ce qui est fort, et non d'amoindrir, en valeurs absolues, ce qui est déjà faible.
La forme de cet auto-renforcement s'apparente en fait assez largement aux mécanismes d'attachement préférentiel \autocite{barabasi_emergence_1999}, où la croissance d'une entité est directement proportionnelle à sa taille.

Dans SimFeodal, l'attachement préférentiel est mobilisé, sous une forme faible, en matière de concentration : les pôles les plus importants attirent plus, et peuvent voir se développer des agrégats et des églises paroissiales qui à leur tour augmenteront leur attractivité.
Cela concoure à des logiques de renforcement des plus forts et d'amoindrissement (relativement à l'ensemble du système) des plus faibles.
%Notons qu'un mécanisme d'attachement préférentiel aboutit a une distribution log-normale de ses composantes, ce qui pourrait être le cas ici pour les tailles des agrégats.
On notera toutefois que dans SimFeodal, la relation entre taille et attraction n'est pas continue mais bornée : à partir d'une certaine taille (un pôle contenant plus de 4 églises paroissiales par exemple), la croissance n'entraîne plus de hausse de l'attractivité.
La forme de la hiérarchisation des tailles de pôles et agrégats n'est donc pas directement assimilable aux structures log-normales issues de l'application théorique de mécanismes d'attachement préférentiel.
A ce titre, on ne peut prédire ou estimer les changements de hiérarchie dans le système depuis le simple énoncé des paramètres et mécanismes, et l'expérimentation par la simulation est alors nécessaire.

\clearpage
\subsection{Théories et concepts de la modélisation agents mobilisés}

Le protocole ODD définit un ensemble de \textit{design concepts} qui peuvent être mobilisés dans la conception d'un modèle à base d'agents.
Pour chacun de ces 10 concepts (voir \cref{tab:proto-ODD}\footnote{
Il nous semble que les dénominations de ces concepts ne sont pas extrêmement claires et intuitives.
Nous recommandons au lecteur de plutôt chercher à les comprendre en lisant les exemples de questions donnés dans la colonne de droite du tableau.
}), nous décrivons brièvement si et comment ils sont appliqués dans SimFeodal.

\paragraph{Émergence} Ce mécanisme constitue l'un des fondements de nombreux modèles complexes, et SimFeodal n'y échappe pas.
La diversité des éléments analysés dans le modèle est trop importante pour faire une liste des éléments qui y émergent (\hl{voir le chapitre 3, section 3.? par exemple}), et l'on peut prendre pour exemple les modifications de structure spatiale des foyers paysans.
Les foyers paysans ne communiquent ni n'interagissent directement les uns avec les autres, et pourtant ils tendent à se regrouper en formant des agrégats.
Le système d'agrégats ainsi formé tend de plus à se hiérarchiser fortement au fur et à mesure des migrations des foyers paysans.
Il y a donc émergence d'un système de peuplement hiérarchisé à partir de choix de migrations individuels.

\paragraph{Adaptation et Objectifs} Dans SimFeodal, le concept d'adaptation n'est pas présent au sens littéral : les agents ne s'adaptent pas à un environnement en modifiant leur comportement.
Toutefois, le comportement, en lui même, de certains agents est largement dépendant de l'environnement.
Les foyers paysans par exemple, sont caractérisés par une satisfaction qui dépend largement de leur localisation spatiale.
Quand cette satisfaction est insuffisante, les foyers paysans migrent.
Il y a donc bien adaptation à l'environnement, quand bien même celle-ci résulte directement du comportement des foyers paysans plutôt que d'une évolution de celui-ci.

De plus, le choix de la destination de la migration n'est pas anodin.
Dans SimFeodal, un mécanisme stochastique pondéré est mobilisé de nombreuses fois pour établir la destination d'un foyer paysan, lors d'un renouvellement (voir \cref{meca-renouvellement}) ou d'une migration locale ou lointaine (\cref{meca-migration}): la \og loterie pondérée\fg{}.
Dans ce mécanisme, les foyers paysans \og choisissent\fg{} leur pôle de destination en fonction de l'attractivité de celui-ci :
plus un pôle est attractif, c'est-à-dire composé de nombreux attracteurs, plus il est susceptible d'attirer.
En migrant vers un pôle plus attractif, les foyers paysans ont une bonne probabilité de voir leur satisfaction augmenter.
Le mécanisme de migration pourrait ainsi être considéré comme un comportement adaptatif visant à augmenter la satisfaction des foyers paysans.

On préfèrera cependant y voir le concept d'\og objectif\fg{}, tel que décrit par les auteurs du protocole ODD : \og If agents (or groups) are explicitly programmed to meet some objectives, what exactly is that and how is it measured ? When individuals make decisions by ranking alternatives, what criteria do they use?\fg{}~(\textcite[353]{grimm_documenting_2017}, voir \cref{tab:proto-ODD})

Les foyers paysans ont donc un comportement adaptatif : individuellement, ils fuient les environnements trop inconfortables.
Ce comportement est enrichi d'une logique d'objectif : en choisissant leur destination, ils visent à augmenter, à défaut de maximiser, leur satisfaction.
Notons que dans ces deux cas, il ne s'agit pas d'intentionnalité consciente des agents, mais des mécanismes mis en places pour modéliser leur comportement à l'échelle agrégée.

\paragraph{Learning \& Prediction} Ces deux concepts, apprentissage et prédiction, ne nous semblent pas adaptés à la description de SimFeodal.

\paragraph{Perception - \textit{Sensing}}
Perception et cognition sont des concepts fortement utilisés dans certains types de modèles\footnote{
	On pourrait ainsi citer les modèles de type \og BDI\fg{} (\textit{Belief}-\textit{Desire}-\textit{Intention}, d'après \cite{bratman1988plans}), où le niveau de connaissance de l'environnement joue un rôle déterminant \autocite[183--184]{crooks_agent-based_2019}.
} où la rationalité du comportement des agents présente un enjeu majeur.\\
Dans SimFeodal, cette recherche de rationalité n'est pas présente, au moins sur un plan individuel.
La logique de perception et de cognition est toutefois mobilisée, au moins en ce qui concerne les agents les plus réactifs du modèle, c'est-à-dire les foyers paysans.
Ceux-ci n'ont pas de mécanisme spécifique dédié à une perception de leur environnement, mais la manière dont leur satisfaction est mesurée s'en rapproche assez largement : les foyers paysans ont une perception parfaite de la configuration spatiale qui les entourent (zones de prélèvement, églises et châteaux les plus proches etc.)

On trouve aussi une logique de perception inégale chez ces agents par la manière dont le mécanisme de migration est formalisé, sous forme d'un choix entre migration locale et migration lointaine (ou globale).
En cas de migration locale, la recherche de destinations potentielles se fait dans le voisinage des foyers paysans.
On peut y voir une notion de perception, et y considérer que ces foyers paysans (ou les foyers paysans \og dépendants\fg{}, par exemple les serfs) ont une perception uniquement locale de leur environnement, contrairement aux autres foyers paysans, qui effectuent des migrations lointaines et auraient alors une connaissance globale du monde modélisé.

\paragraph{Interaction} L'interaction est un concept qui est presque indissociable de la plupart des modèles à base d'agents.
On peut l'entendre dans le sens d'interactions entre des agents d'un même type, ou entre agents de types différents.

Dans SimFeodal, les interactions directes entre agents de même type sont assez minimes : on peut y inscrire les logiques de dons entre seigneurs, qui ont donc une interaction directe à cette occasion, notamment encouragée par une proximité spatiale.
De manière moins directe, on peut aussi voir une interaction entre foyers paysans dans la constitution des agrégats : c'est par leur co-présence que les agrégats sont définis, et ces agrégats influent à leur tour sur le comportement des foyers paysans (en leur apportant potentiellement une meilleure satisfaction).
L'interaction entre les foyers paysans est donc indirecte, par le biais de l'entité de niveau supérieur qu'ils constituent, mais demeure une interaction dont les éléments atomiques sont bien les foyers paysans.

L'autre grand type d'interaction qui peut être modélisé concerne des agents de types différents.
Cet usage est sans doute encore plus répandu, notamment dans les nombreux modèles qui font interagir des agents avec leur environnement.
Quand ce dernier est agentifié (via des \textit{patchs} ou cellules par exemple), et possède donc des attributs et comportements propres (une certaine quantité de ressources par exemple, qu'un comportement peut faire augmenter), il peut entrer en interaction avec un agent plus classique.
Les modèles inspirés de \mbox{\og Sugarscape\fg{}} \autocite{epstein_growing_1996} sont emblématiques de cette approche, avec une interaction directe sous forme d'agents mouvants qui consomment leur environnement représenté par des cellules contenants du \og sucre\fg{} qui \og pousse\fg{} régulièrement.\\
Dans SimFeodal, la forme des interactions entre les agents et leur environnement n'est pas aussi classique, mais constitue néanmoins un fondement du modèle.
La satisfaction des foyers paysans (et leur comportement, que la satisfaction affecte) dépend très largement de leur environnement et des autres agents qui le constituent : distance des églises, des châteaux, présence et nombre de zones de prélèvement etc.

\paragraph{Stochasticité} Dans les parties précédentes de ce chapitre, on a plusieurs fois mentionné l'importance de la stochasticité dans SimFeodal.
Celle-ci est omniprésente : dès l'initialisation du monde (\cref{meca-init}), la distribution des foyers paysans, agrégats, églises et seigneurs est entièrement aléatoire.
En parcourant l'ensemble du déroulement de SimFeodal (\cref{fig:ordonnancement}), on peut constater que tous les mécanismes comportent une part important de stochasticité\footnote{
	À l'exception des mécanismes de \og délimitation\fg{} des entités spatiales (agrégats, pôles et paroisses) et de l'enregistrement des sorties.
}.
L'aléa est présent dès le départ , \textit{a minima} sur l'ordre d'appel des agents (\cref{meca-ordonancement}), et de manière bien plus importante dans d'autres mécanismes (loteries pondérées, probabilités de migration, probabilité de construction et de localisation de châteaux\ldots).
Conjuguée avec la complexité du modèle, c'est-a-dire l'imbrication des mécanismes qui rend leur comportement non linéaire, la stochasticité concoure à faire de SimFeodal un modèle profondément complexe.
On ne peut prédire le comportement du modèle, ni même l'effet de certains paramètres (\hl{voir le chapitre 6, section analyse de sensibilité, ou chapitre 3 sur l'évaluation des params}), sans le simuler.

\paragraph{Collectifs} Cette partie de la grille de lecture ODD interroge l'existence et la constitution de \og collectifs\fg{}, c'est-à-dire d'agrégats d'entités individuelles, ainsi que la manière dont ils sont implémentés : dotés
d'attributs propres ou enrichissant les attributs des entités constituantes.
\\
Dans SimFeodal, l'exemple le plus évident est celui des agrégats, entités composites constituées de foyers paysans.
Les agrégats ont leurs attributs propres, qui dépendent toutefois largement des foyers paysans (attractivité, emprise spatiale) qui les composent.
Les agrégats ont également une caractéristique propre, qui ne dépend pas des foyers paysans les composant : l'existence en leur sein d'une communauté paysanne, modélisée sous la forme d'un attribut des agrégats.
Cette caractéristique joue, sous la forme d'une boucle de rétroaction, sur les foyers paysans qui composent l'agrégat puisque la présence d'une communauté dans leur agrégat augmente mécaniquement la satisfaction matérielle et générale des foyers paysans.

Les pôles d'attraction sont un autre exemple de collectif.
Ils sont ainsi composés d'attracteurs (églises paroissiales, châteaux et agrégats de population) situés à proximité les uns des autres.
Comme pour les agrégats, certains attributs des pôles dérivent directement des attracteurs les composant, par exemple leur géométrie.
Les pôles ont aussi une caractéristique propre : leur attractivité dépend certes des attracteurs qui les composent, mais cette relation n'est pas strictement de l'ordre du cumul : l'attractivité des pôles est discrète plutôt que continue et basée sur des seuils.
Par exemple, les quatre premières églises paroissiales qui font parti d'un pôle lui apportent un surplus d'attractivité, mais on considère qu'au delà, une nouvelle église paroissiale n'augmentera plus l'attractivité de ce pôle.

%L'autre propriété des pôles, leur attractivité, dépend aussi directement des attracteurs qui les composent, sans toutefois que la relation soit strictement cumulative : une cinquième église paroissiale n'apportera pas d'attractivité au pôle dont elle fait partie (voir \cref{tab:attraction-poles}).

\paragraph{Observation} Ce dernier \og design concept\fg{} nous semble différer fortement des autres concepts décrits dans le protocole ODD\footnote{
Il est décrit ainsi dans \textcite[354]{grimm_documenting_2017} :
\og What data are collected from the ABM for testing, understanding, and analyzing it, and how are they collected ? \fg{}
}.

Il s'agit de définir les données produites et collectées par le modèle à base d'agents.
Dans SimFeodal, la collecte d'un maximum de données est indispensable à la bonne évaluation du modèle, qui ne peut être exécutée qu'à posteriori et par l'intermédiaire d'une \og évaluation visuelle\fg{} basée sur l'étude de nombreux indicateurs de sortie hétérogènes\footnote{
	Ces problématiques occupent une large partie du \hl{chapitre 5} et nous les y expliciterons à cette occasion.
}.
SimFeodal est un modèle dont l'un des objectifs est de produire des données, lesquelles permettront de comprendre le modèle ultérieurement.
Cette vision s'oppose à celle des modèles plus théoriques et parcimonieux, tel que celui de Schelling, qui peuvent être appréhendé directement pendant leur exécution. 


\clearpage
\let\orisectionmark\sectionmark
\renewcommand\sectionmark[1]{}%
\section[Situation initiale -- \textit{Details - Initialisation}]{Situation initiale -- \large{\textit{Details - Initialisation}}\label{sec:initialisation}}
\orisectionmark{Situation initiale}
\let\sectionmark\orisectionmark

\setcounter{savefootnote}{\value{footnote}}

\subsection{Une situation initiale théorique et générée de manière endogène}

SimFeodal est un modèle qui prend appui sur un espace théorique, très générique et épuré.
Dans cet espace, certains agents se déplacent et font émerger des configurations spatiales particulières que l'on cherche à étudier.
Le choix de la configuration initiale, qui sera transformée au cours du modèle, 
revêt donc une importance considérable, puisqu'il conditionne (ou tout du moins influence) les structures spatiales qui en seront issues.
Afin de pouvoir maitriser la \og path-dependency\fg{} induite par la situation initiale, on a choisi de contrôler entièrement l'initialisation du modèle en l'intégrant, de manière endogène, aux mécanismes de SimFeodal.
L'initialisation du monde simulé constitue donc un premier \og sous-modèle\fg{} de SimFeodal, chargé de générer le monde dans lequel les agents évolueront.
Le sous-modèle d'initialisation consiste en l'exécution de 3 mécanismes dédiés chacun à la création d'un type d'agent : création des églises ; des foyers paysans et agrégats ; et enfin création des seigneurs.
Dans l'ensemble, un principe commun oriente la création de ces agents : ils sont répartis de manière presque aléatoire (voir \cref{meca-init}) dans l'espace \og actif\fg{} simulé du modèle.

\paragraph{Églises}
Empiriquement, on estime qu'environ 150 églises pré-existent à la période modélisée.
Elles sont réparties de manière assez irrégulière et dispersée, à proximité de villages de petites villes mais aussi isolées dans l'espace rural.\\
Dans SimFeodal, on modélise cette configuration spatiale en répartissant ces 150\unskip\astfootnote{Ce nombre est paramétrable.\label{ftn:nombre-parametrable}} églises, de manière aléatoire dans l'espace du modèle.
Pour représenter, parmi ces édifices religieux, ceux qui sont dotés des droits paroissiaux (environ une cinquantaine au début de la période), on tire aléatoirement un tiers\footref{ftn:nombre-parametrable} de ces églises.
On attribue alors à ces églises les droits paroissiaux, et elles deviennent dès lors le semis ponctuel autour duquel le maillage paroissial (zonal) est dessiné.


\paragraph{Foyers paysans et agrégats}
La création des foyers paysans est plus complexe, notamment car elle doit être aléatoire au niveau individuel tout en respectant une structure macroscopique contrôlée par les modélisateurs via les paramètres.
De manière empirique, on peut résumer la distribution spatiale initiale à une immense majorité de foyers paysans dispersés, et à la pré-existence de quelques villages (peu peuplés) et petites villes (les agglomérations secondaires antiques, plus conséquentes en termes de population).\\
Pour générer la configuration initiale, on reproduit ces grandes lignes de manière aléatoire tout en faisant en sorte que ces villages et petites villes soient bien modélisées sous la forme d'agrégats plus ou moins peuplés.
On commence donc par répartir dans l'espace quelques\footref{ftn:nombre-parametrable} agrégats (les \og petites villes\fg{} empiriques) peuplés d'une trentaine\footref{ftn:nombre-parametrable} de foyers paysans, lesquels sont placés de manière suffisamment proches pour pouvoir constituer un agrégat au sens du modèle (voir \cref{meca-agregats}).
La \cref{fig:init-fp} illustre la démarche mise en place pour créer ces agrégats.
On répète cette démarche pour les \og villages\fg{}, en plaçant à nouveau quelques\footref{ftn:nombre-parametrable} agrégats dans l'espace, cette foi constitués d'une dizaine\footref{ftn:nombre-parametrable} de foyers paysans.
On peut alors disperser, de manière entièrement aléatoire, tous les foyers paysans qui n'ont pas encore été localisés dans l'espace du modèle, c'est-à-dire ceux qui ne font pas partie des agrégats précédemment créés.

\begin{figure}[H]
	\centering
	\includegraphics[width=.98\linewidth]{img/init_fp.pdf}
	\caption{Étapes successives de l'initialisation des foyers paysans agrégés (petites villes et villages).\\
	(A) On génère un foyer paysan ;\\
	(B) on génère un nouveau foyer paysan dans un rayon donné du premier ;\\
	(C) et (D) on continue à générer de nouveaux foyers paysans dans le rayon de n'importe lequel des foyers existants ;\\
	(E) la géométrie d'un agrégat correspond à l'enveloppe convexe des foyers paysans ;\\
	(F) en fin d'initialisation, les étapes A à E ont été répétées pour le nombre d'agrégats initiaux défini, et l'ensemble des agrégats sont donc dispersés dans l'espace actif (voir \cref{fig:espace-simfeodal}) du modèle.}
	\label{fig:init-fp}
\end{figure}


\paragraph{Seigneurs}
Parmi les seigneurs, on distingue deux types : les grands seigneurs, sans représentation spatiale, et les petits seigneurs, localisés dans l'espace du modèle.
L'initialisation spatiale des seigneurs ne concerne donc que les petits seigneurs, dont l'on estime empiriquement le nombre initial à une vingtaine\footref{ftn:nombre-parametrable}.\\
À l'initialisation de SimFeodal, on répartit ces cinquante seigneurs dans l'espace du modèle, d'une manière semi-aléatoire : on considère que les seigneurs doivent être localisés dans l'un des agrégats créés à l'étape précédente.
Les seigneurs tirent aléatoirement un agrégat, et sont placés de manière aléatoire au sein de la délimitation de cet agrégat.
Plusieurs seigneurs peuvent ainsi être situés dans le même agrégat, et certains agrégats peuvent de la même manière ne contenir aucun seigneur.

%Le mécanisme de création des premiers seigneurs est tout aussi simple et aléatoire : on répartit, de manière toujours aléatoire, un nombre donné de grands seigneurs.\\
%On localise aussi, selon un aléa contraint, un ensemble\footref{ftn:nombre-parametrable} de petits seigneurs au sein des agrégats existants, lesquels ont été délimités selon le mécanisme standard (voir \cref{meca-agregats}).
%Les petits seigneurs générés se voient directement associés à une zone de prélèvement de type \og foncier\fg{}, de rayon et de taux de prélèvement aléatoires bornés : dès l'initialisation, les premières zones de prélèvement sont donc créées.


\clearpage
\subsection{Paramètres d'initialisation}

Dans la partie précédente, on a plusieurs fois indiqués que certaines des valeurs numériques de l'initialisation étaient paramétrables, c'est-à-dire qu'on peut les faire varier afin de générer des structures spatiales initiales différentes.
Cela participe à la recherche de maîtrise de l'espace support initial de SimFeodal, où il n'y a aucun \og \textit{input}\fg{}, mais un ensemble de paramètres régissant les différents sous-modèles.
Pour l'initialisation, les paramètres sur lesquels on peut jouer pour tester différents scénarios sont précisés dans le \cref{tab:params-initiaux}.

\input{chap2/img/tableau-parametres-init}



\begin{center}	
	\hl{Fin des reprises le 2019-07-05, version papier}
\end{center}


\let\orisectionmark\sectionmark
\renewcommand\sectionmark[1]{}%
\section[Données en entrée -- \textit{Input data}]{Données en entrée -- \large{\textit{Input data}}}
\orisectionmark{Données en entrée}
\let\sectionmark\orisectionmark

L'initialisation de SimFeodal constitue un sous-mécanisme à part entière, entièrement endogène au modèle.
À ce titre, on ne peut dire que des données en entrée (\textit{inputs}) contrôlent l'état initial du modèle, tel que c'est la norme dans des modèles spatiaux classiques.
Pour autant, on peut voir une forme d'\textit{inputs} dans les nombreux paramètres mobilisés pour l'initialisation et dans ceux, plus nombreux encore, qui influencent l'ensemble des mécanismes.

Par exemple, pour mettre en place des comportements exogènes permettant de faire varier le modèle à différentes dates précises, on peut classiquement faire appel à des données de sortie d'un autre modèle, ou à un fichier de configuration.
Dans SimFeodal, cette logique est bien présente, mais est gérée directement au sein du modèle, sans faire appel à des données externes.
Certains paramètres prennent ainsi la forme de tableaux d'associations (aussi appelés dictionnaires, ou \og \texttt{map}\fg{} en informatique), qui mettent en correspondance des valeurs de paramètres à des dates précises (voir \cref{lst:maps-gama}).
\medskip

{\footnotesize
	\begin{lstlisting}[caption={
	Deux exemples de \texttt{map} dans Gama.
	\textit{À partir de 800, les églises doivent se situer entre 5 et 25~km, puis entre 3 et 10~km de 960 à 1060, et entre 1.5 et 5~km après cette date.}}, captionpos=b, label={lst:maps-gama}]
map<int,int> dist_min_eglise <- [800::5000,  960::3000,  1060::1500];
map<int,int> dist_max_eglise <- [800::25000, 960::10000, 1060::5000]; 
	\end{lstlisting}
}

%Comme indiqué, il n'y a pas véritablement d'\textit{inputs} dans SimFeodal : tout est paramètre, et dès lors dynamique.
%En même temps, le modèle comporte de très nombreux paramètres : entre une quarantaine et une soixantaine selon les définitions possibles de ce qu'est un paramètre, voir \hl{chapitre 4}.\\
%On peut donc voir dans la multiplicité des paramètres une proximité avec la notion de données en entrée, qui ne s'expriment toutefois pas sous la forme traditionnelle.

%Pour respecter le formalisme ODD que suit ce chapitre, on peut au final considérer que SimFeodal est un modèle qui ne repose sur aucune donnée en entrée.
%Conceptuellement, le rôle joué par les paramètres du modèle s'en approche toutefois assez fortement.
%Le \hl{chapitre 4} permet d'éclairer cette description en entrant plus en détail dans la définition et la nomenclature des paramètres.

Quand bien même ce n'est pas le sens traditionnel d'\textit{inputs}, la multiplicité des paramètres et leur forte diversité (\hl{voir chapitre 4}) remplit le même rôle.
Il s'agit de contrôler précisément l'initialisation du modèle, mais aussi des éléments et événements indispensables, sur le plan empirique, qui ne doivent pas émerger des interactions du modèle, mais au contraire, les conditionner.

\begin{center}	
	\hl{Fin des reprises le 2019-07-05, version numérique}
\end{center}

\let\orisectionmark\sectionmark
\renewcommand\sectionmark[1]{}%
\section[Mécanismes spécifiques -- \textit{Submodels}]{Mécanismes spécifiques -- \large{\textit{Submodels}}\label{sec:meca-specifiques}}
\orisectionmark{Mécanismes spécifiques}
\let\sectionmark\orisectionmark


\subsection{Introduction}

Cette partie du chapitre est plus technique, et vise à présenter précisément différents mécanismes de SimFeodal évoqués dans la partie relative au fonctionnement général du modèle (\cref{sec:fonctionnement-general}).
Nous avons ici fait le choix de présenter les mécanismes sous la forme, discursive et schématique, la plus courte et compréhensible, quand bien même cette forme n'est qu'une \og équivalence\fg{} de la réalité de l'implémentation.
Ces écarts entre présentation discursive des mécanismes et implémentation effective sont discutés dans l'\cref{enc:polarite-implementation}.

Dans un objectif de lisibilité, on a choisi de ne pas entreprendre une description détaillée et exhaustive de tous les détails d'implémentation.
Il nous semble en effet que ces éléments présentent un intérêt fondamental en termes de reproductibilité, mais qu'une description très précise présenterait aussi un caractère redondant avec le code-source du modèle.
Celui-ci est disponible publiquement (voir l'\hyperlink{avant-propos}{avant-propos}) et à notre sens, est partie intégrante de ce travail de thèse.
Sa reproduction à l'écrit, dans ces pages, même sous forme d'annexe, nous semble assez peu appropriée, mais cela n'enlève rien, de notre point de vue, à la nécessité de sa consultation pour une compréhension plus fine du modèle.

%Notons aussi que la présentation des mécanismes n'est pas nécessairement exacte, c'est-à-dire une description fidèle de la manière dont les mécanismes sont implémentés informatiquement sous forme de codes-sources.

On remarquera enfin que nous avons préféré présenter ces mécanismes spécifiques dans un ordre différent de celui de l'ordonnancement dans le modèle (cf. \cref{fig:ordonnancement}), en les regroupant plutôt suivant les types d'agents concernés par chacun.
On présentera d'abord les mécanismes \og globaux\fg{}, c'est-à-dire relevant de la détection des agrégats, pôles et des logiques de promotion et création de paroisses ; puis les mécanismes relatifs au foyers paysans ; et enfin ceux impliquant l'action des seigneurs.

\bigskip 
\begin{encadre}{Écarts entre présentation et implémentation}{polarite-implementation}
	
La présentation des mécanismes d'un modèle ne suit pas toujours la manière dont ces mécanismes sont implémentés dans le code-source d'un modèle.
C'est naturellement vrai entre deux \og domaines\fg{} d'un modèle (si l'on reprend la triade des domaines conceptuels, empirique et informatique de \textcite[\ppno~3, fig. 2]{sargent2009verification}), au vu des écarts qu'il peut y avoir par exemple entre le modèle conceptuel et le modèle implémenté.
Toutefois, cela peut aussi se produire au sein d'un même domaine, par exemple ici pour le domaine du modèle informatique (\og computerized model\fg{} chez Sargent), notamment dans la phase de l'implémentation.
La présentation discursive d'un modèle suit ses règles propres, par exemple la nécessité de suivre une progression linéaire.
L'implémentation informatique, au contraire, ne suit pas forcément les mêmes règles, et tend même à requérir des logiques très différentes au nom d'une \og optimisation\fg{} du code-source, propre à chaque langage informatique.
Dans cet encadré, nous souhaitons mettre en avant trois types de processus où la présentation discursive et l'implémentation effective sont différentes tout en menant à des aboutissements équivalents.
Cette typologie ne vise pas l'exhaustivité, mais s'articule autour d'exemples rencontrés dans la présentation du modèle qui est faite dans ce chapitre.

\paragraph{Point de vue de l'implémentation} Quand un tirage aléatoire probabiliste est appliqué sur un grand nombre d'entités, son espérance théorique tend vers une fréquence empirique, en vertu de la loi des grands nombres.
En simulation à base d'agents, cela signifie que choisir une proportion de 10\% d'une large population (\og probabilité de groupe\fg{}) est quasi-équivalent à doter chacun des individus d'une probabilité de $0.1$ d'être choisis (\og probabilité individuelle\fg{}).
Cette équivalence est fortement mobilisée dans SimFeodal, le \og point de vue\fg{} -- probabilité individuelle ou de groupe -- changeant parfois à plusieurs reprises dans un même mécanisme, selon la praticité ou la performance (informatique) de l'une ou l'autre.
Dans la description du modèle, on essaie d'avoir la vision la plus \og agent-centrée\fg{} possible.
On présentera préférentiellement les mécanismes comme faisant appel à des probabilités individuelles, quand bien même l'implémentation effective se base sur une approche proportionnelle, mobilisant des probabilités de groupe.

\paragraph{Factorisation} Un autre écart tient à l'ordre d'exécution des sous-mécanismes par un ensemble d'agents.
En mathématiques, $k\times (x+y)$ est égal, selon les règles de factorisation, à $k{\cdot}x + k{\cdot}y$.
Dans un système multi-agents, la logique est la même.
On considère ainsi que même si l'ordre d'appel des agents diffère et peut faire varier le résultat, les sous-mécanismes décrits sont équivalents (plutôt qu'égaux).
Les programmes \ref{lst:facto1} et \ref{lst:facto2} sont ainsi considérés comme équivalents en dépit de la différence dans leur ordre d'appel.
Le premier programme demande à tous les agents, chacun leur tour, d'effectuer les mécanismes A et B successivement.
Le second est légèrement différent en ce qu'il demande d'abord à tous les agents d'effectuer A, et une fois que A est réalisé pour chacun, d'effectuer B : \bigskip

\noindent\begin{minipage}[b]{.45\textwidth}
	\begin{lstlisting}[caption={Factorisé},frame=tlrb, captionpos=b, label = {lst:facto1}]
ask agents [
  do A;
  do B;
]
	\end{lstlisting}
\end{minipage}\hfill
\begin{minipage}[b]{.45\textwidth}
	\begin{lstlisting}[caption={Développé},frame=tlrb, captionpos=b, label = {lst:facto2}]
ask agents [
  do A; ]
ask agents [
  do B; ]
	\end{lstlisting}
\end{minipage}

En terme d'efficacité du code, l'alternance entre ces deux approches permet de résoudre certaines difficultés d'implémentation.
On peut ainsi factoriser les calculs légers et au contraire développer, pour faciliter le stockage intermédiaire entre autre, les calculs plus lourds.
En revanche, pour bien différencier les étapes successives, dans le cadre d'une description discursive, il sera souvent plus aisé de présenter les sous-processus de manière développée plutôt que factorisée.

\paragraph{Optimisation} Les deux types de processus précédents peuvent être combinés, pour répondre à des questions d'optimisation informatique, par exemple pour permettre au modèle de fonctionner plus rapidement en fonction des spécificités des langages informatiques choisis.
Dans Gama, par exemple, il est plus lent, informatiquement, de calculer la distance depuis 1000 agents à 10 agents, que l'inverse, quand bien même les résultats sont strictement identiques.
Le calcul de la satisfaction de protection des foyers paysans en offre un exemple.
Il requiert de mesurer la distance de chaque agent concerné au château le plus proche.
Il est bien plus rapide de calculer cette mesure depuis les châteaux, puis de sélectionner la distance minimale pour chaque couple (foyer paysan; château).
Dans cet exemple, l'implémentation se fait dans un sens opposé à celui du discours, sans que cela n'ait la moindre conséquence sur le plan conceptuel.
Il en résulte toutefois une bien meilleure optimisation du modèle informatique en terme de rapidité d'exécution.
\end{encadre}

\subsection{Mécanismes globaux}

\subsubsection{Identification des agrégats \label{sssec:agregats}}
	
\begin{figure}[H]
	\centering
	\includegraphics[width=.75\linewidth]{img/detection_agregats.pdf}
	\caption{Détection et de l'héritage des agrégats.}
	\label{fig:detection-agregats}
\end{figure}

La \cref{fig:detection-agregats} présente les étapes successives de détection des agrégats.
À chaque pas de temps, on repart d'une situation \og neutre\fg{}, c'est-à-dire que tous les foyers paysans sont considérés comme dispersés (\textbf{A}).
On exécute un algorithme de classification basé sur la distance\footnote{
	L'opérateur Gama \textsf{simple\_clustering\_by\_distance}, proche conceptuellement de l'algorithme DBSCAN.
} : les \textit{clusters} constitués d'au moins 5 foyers paysans espacés de moins de 100~m sont considérés comme des agrégats(\textbf{B}).
On fixe alors la géométrie des agrégats, qui prend la forme de l'enveloppe convexe des foyers paysans qui les composent (\textbf{C}).
Les foyers paysans inclus dans la surface d'un agrégat y sont ajoutés (\textbf{D}).
On crée ensuite des \textit{buffers} de 100~m autour des agrégats et on y rattache à nouveau les foyers paysans inclus dans la surface (\textbf{E}).
Dernière étape dans la détection des agrégats, pour ne pas multiplier les agrégats proches les uns des autres, on procède à une étape de fusion : on réalise l'union géométrique des agrégats qui s'intersectent (\textbf{F}).\\
Les trois dernières étapes concernent la transmission des propriétés des agrégats à travers les pas de temps, et en particulier de la présence ou non d'une communauté en leur sein.
On isole les agrégats du pas de temps précédent qui intersectent les nouveaux agrégats (\textbf{G}).
On procède ensuite à une intersection entre les géométries de ces anciens agrégats et le nouvel agrégat (\textbf{H}).
Le nouvel agrégat hérite alors des propriétés de l'ancien agrégat dont la superficie d'intersection est la plus importante, c'est-à-dire l'agrégat orange ici (\textbf{I}).
	
	\subsubsection{Identification des pôles \label{sssec:poles}}

\begin{figure}[H]
	\centering
	\includegraphics[width=\linewidth]{img/detection_poles.pdf}
	\caption{Les étapes du mécanisme de détection et de calcul d'attractivité des pôles.}
	\label{fig:detection-poles}
\end{figure}

Les pôles sont des agents composés d'attracteurs de trois types : les châteaux (petits et gros), les églises (uniquement celles dotées de droits paroissiaux) et les agrégats (uniquement ceux comportant une communauté paysanne).
Les pôles et leur délimitation spatiale revêtent une importance particulière lors de la migration des foyers paysans : ils attirent d'autant plus que leur attractivité est importante, et le cas échéant, les foyers paysans migrants s'installent à l'intérieur de leur délimitation.
La \cref{fig:detection-poles} illustre la méthode de définition spatiale des pôles, ainsi que des exemples de calcul de leurs attractivités.

À chaque pas de temps, on repart d'une situation \og neutre\fg{}, c'est-à-dire que l'on recalcule systématiquement les pôles sans repartir des pas de temps précédents (\textbf{A}).
On commence par identifier les attracteurs situés à moins de 200~m les uns des autres (\textbf{B}) pour identifier les pôles : ceux-ci peuvent être constitués de plusieurs attracteurs proches, ou d'un unique attracteur.
L'enveloppe spatiale des pôles est définie comme un \textit{buffer} de 200~m autour de l'enveloppe convexe formée par le centroïde des attracteurs qui les composent (\textbf{C}).
Il s'agit par conséquent d'un cercle de rayon de 200~m pour les pôles mono-attracteurs, et d'un polygone pour les pôles composites.
Afin de renforcer la probabilité de voir croître les agrégats à proximité des pôles, on fusionne (union géométrique) l'enveloppe spatiale des pôles avec les contours de l'ensemble des agrégats (comportant ou non une communauté paysanne) intersectés.
Cela permet à des pôles peu éloignés de fusionner à leur tour (\textbf{D}).
On peut alors calculer leur attractivité en se reportant au \cref{tab:attraction-poles} (p.~\pageref{tab:attraction-poles}) (\textbf{E}).


	
	\subsubsection{Création et promotion d'églises paroissiales \label{sssec:paroisses}}
	
	\begin{figure}[H]
		\centering
		\includegraphics[width=1\linewidth]{img/constru-promo_paroisses_rurales.pdf}
		\caption{Construction et promotion de paroisses en zone peu dense.}
		\label{fig:promotion-paroisses}
	\end{figure}
	
\clearpage
\subsection{Foyers paysans}

	\subsubsection{Satisfaction et modèles gravitaires \label{sssec:satisfaction}}
	
Les satisfactions religieuses et de protection des foyers paysans suivent une logique proche du modèle gravitaire : plus les foyers sont éloignés des \og attracteurs\fg{} (les châteaux pour la satisfaction protection ; les églises paroissiales pour la satisfaction religieuse), moins ils sont satisfaits.
Cette logique simple est légèrement contrainte par l'introduction de seuils : en dessous d'une certaine distance (\textit{distance\_min}), le foyer paysan est entièrement satisfait (satisfaction = 1), et au delà d'une autre distance (\textit{distance\_max}), sa satisfaction est nulle (satisfaction = 0).
Entre ces deux seuils, minimaux et maximaux, la satisfaction suit une logique gravitaire simple, soit ici une décroissance linéaire.
L'équation \ref{eq:satisfaction-distance} permet de formaliser ce type de calcul, et la \cref{fig:satisfaction-distance} l'illustre de manière sans doute plus accessible.

\begin{figure}[H]
	\centering
	\begin{equation}\label{eq:satisfaction-distance}
	\begin{gathered}
	satis\_dist = min  \left \lbrack max \left \lbrack \frac{(distance\_max - distance\_attracteur)}{(distance\_max -distance\_min)}; 0 \right \rbrack ; 1 \right \rbrack
	\end{gathered}
	\end{equation}
	\includegraphics[width=.8\linewidth]{img/satisfaction_distance.pdf}
	\caption{Évolution de la satisfaction en fonction de la distance à l'attracteur le plus proche.}
	\label{fig:satisfaction-distance}
\end{figure}

\paragraph{Satisfaction religieuse}
		
Le calcul de la satisfaction religieuse s'inscrit rigoureusement dans cette logique.
On peut le formuler ainsi :
		\begin{equation*}
		s_{religieuse} = min  \left \lbrack max \left \lbrack \frac{(distance_{max} - distance\_eglise)}{(distance_{max} -distance_{min})}; 0 \right \rbrack ; 1 \right \rbrack
		\end{equation*}
avec les seuils de distance ($distance\_max$ et $distance\_min$) qui évoluent au cours du temps de telle manière :
\begin{itemize}
	\item avant 960 : $distance_{min}$ = 5 km et $distance_{max}$ =  25 km
	\item de 960 à 1060 : $distance_{min}$ = 3 km et $distance_{max}$ =  10 km
	\item après 1060 : $distance_{min}$ = 1,5 km et $distance_{max}$ =  5 km
\end{itemize}
	
\paragraph{Satisfaction protection}	

La satisfaction protection mobilise une logique proche, c'est-à-dire qu'elle est fonction de la distance au château le plus proche.
Cette distance est ici pondérée par un paramètre ($besoin\_protection$) qui permet de prendre en compte la réaction face à un climat de violence, lequel tend à augmenter pendant la période.

\begin{equation*}
s_{protection} = (s_{distance\_chateau})^{(besoin\_protection)}
\end{equation*}
avec
\begin{equation*}
\begin{gathered}
s_{distance\_chateau} = min  \left \lbrack
max \left \lbrack \frac{(dist_{max} - distance\_chateau)}{(dist_{max} -distance_{min})}; 0.01 \right \rbrack ; 1 \right \rbrack
\end{gathered}
\end{equation*}
($dist_{min}$ = 1,5 km et $dist_{max}$ = 5 km )
et le besoin de protection évolutif :
\begin{itemize}
	\item avant 960 : $besoin\_protection = 0 $
	\item de 960 à 1020 : $besoin\_protection = 0.2 ; 0.4 ; 0.6 ; 0.8$
	\item après 1020 : $besoin\_protection = 1$
\end{itemize}

\paragraph{Satisfaction matérielle}

La satisfaction matérielle ne prend aucune distance en compte : elle s'appuie sur le montant des taxes dont le foyer paysan doit s'acquitter ($redevance\_acquittees$).
Ce montant est pondéré par un paramètre technique représentant un niveau \og acceptable\fg{} de taxation ($coef\_redevances$, qui vaut $15$ ici).
L'appartenance du foyer paysan à une communauté finit de contre-balancer le montant des redevances acquittées, sous la forme d'un contre-poids dont l'importance augmente au fur et à mesure de la période modélisée ($puissance\_communaute$ vaut $0.2$ jusqu'en 1060, puis augmente de $0.2$ à chaque pas de temps pour atteindre $1$ en 1040 et rester à ce niveau).

\begin{equation*}
\begin{gathered}
s_{materielle} = (s_{redevance})^{(1-puissance\_communaute)}
\end{gathered}
\end{equation*}
avec 
\begin{equation*}
\begin{gathered}
s_{redevance} = max \left[ \left( 1- \frac{redevances\_acquittees}{coef\_redevances} \right) ; 0 \right]
\end{gathered}
\end{equation*}

\paragraph{Satisfaction générale}

La satisfaction générale est mesurée en prenant le minimum de ces satisfactions individuelles, c'est-à-dire qu'on considère qu'elles ne s'équilibrent pas.
Comme pour la satisfaction matérielle qui la compose, l'appartenance du foyer paysan à une communauté paysanne tend aussi à augmenter la satisfaction générale.
Les communautés interviennent donc à deux reprises dans le calcul de la satisfaction, afin d'illustrer le poids que prennent ces structures sociales et institutionnelles au cours de la période modélisée.

Le calcul de la satisfaction s'exprime ainsi :
\begin{equation*}
\begin{gathered}
\begin{split}
satisfaction =~& 0.75 \times \left[ min \left( s_{materielle} ; s_ {religieuse}; s_{protection} \right) \right] + \\
& 0.25 \times [appartenance\_communaute]
\end{split}
\end{gathered}
\end{equation*}
avec $ \{satisfaction ; s_{materielle} ; s_ {religieuse} ; s_{protection}\} \in [0,1]$ et $[appartenance\_communaute] \in \{0;1\} $


	\subsubsection{Migration des foyers paysans \label{sssec:migration}}

La migration des foyers paysans est sans doute le mécanisme le plus complexe et ayant subi les plus fortes évolutions depuis la conception de SimFeodal.
La règle d'ensemble est pourtant extrêmement simple : un foyer paysan a une probabilité de migrer qui est inversement proportionnelle à sa satisfaction. 
Autrement dit, $P \left( migration \right) = \left( 1 - satisfaction \right)$.
Cette règle simple a été progressivement complexifiée afin d'augmenter la rationalité et l'ancrage empirique des choix de localisation.
Une première complexification a abouti à la distinction de migrations \og locales\fg{} et de migrations \og lointaines\fg{} (voir \cref{fig:migrations-locales-lointaines}).

\begin{figure}[H]
\centering
\includegraphics[width=1\linewidth]{img/migration_locale-lointaine.pdf}
\caption{Migrations locales et lointaines.}
\label{fig:migrations-locales-lointaines}
\end{figure}
Pour aboutir à cette différence entre migration locale et migration lointaine, la règle est encore une fois complexe : les foyers paysans privilégient les migrations locales, et quand celles-ci ne sont pas possibles, ils ont une probabilité plus faible d'effectuer une migration lointaine.
Notons que pour nous approcher des connaissances empiriques, nous avons établi un comportement légèrement différent entre les foyers paysans déjà agrégés et ceux qui seraient dispersés lors de l'exécution du mécanisme de migration (\cref{fig:choix-migration}).
\begin{figure}[H]
	\centering
	\includegraphics[width=0.9\linewidth]{img/choix_migration.pdf}
	\caption{Décision de migration.}
	\label{fig:choix-migration}
\end{figure}

Une dernière distinction a été opérée entre les foyers paysans classiques, libres de leurs migrations, et les foyers paysans \og dépendants\fg{}.
Ces derniers représentent les foyers qui n'avaient pas le droit de quitter le domaine de leur seigneur (les serfs entre autres).
Ceux-là ne peuvent effectuer que des migrations locales, et on considère qu'ils seront amenés à migrer plus facilement, ce qui change encore une fois leur mécanisme de migration (\cref{fig:choix-migration-dependants}).
\begin{figure}[H]
	\centering
	\includegraphics[width=0.9\linewidth]{img/choix_migration_dependants.pdf}
	\caption{Décision de migration des foyers paysans dépendants.}
	\label{fig:choix-migration-dependants}
\end{figure}
 

	
\subsection{Seigneurs}
	\subsubsection{Prélèvement des droits \label{sssec:collecte-droits}}
\setcounter{footnote}{\value{savefootnote}}
Les seigneurs, petits et grands, collectent les droits dont doivent s'acquitter les foyers paysans (droits de haute justice et autres droits) majoritairement (exception faite des droits fonciers pour les grands seigneurs, voir \cref{fig:prelevement-fonciers}) par l'intermédiaire des zones de prélèvement.
Ces zones sont caractérisées par un propriétaire (le seigneur qui les possèdent), éventuellement un gardien (le seigneur à qui la zone a été \og donnée\fg{}, voir \cref{meca-dons}), une localisation\footnote{
	Pour les petits seigneurs, il s'agit de leur propre localisation
}, un rayon\footnote{
	Ce rayon est tiré aléatoirement suivant une distribution uniforme, \\$rayon\_zp \sim \mathcal{U}\left[ rayon\_min\_zp\_ps , rayon\_max\_zp\_ps \right]$, avec $rayon\_min\_zp\_ps$ et $rayon\_max\_zp\_ps$ des paramètres qui valent respectivement 1 000 et 5 000 m.
} et un taux de prélèvement\footnote{
	idem : $taux\_prelevement\_zp \sim \mathcal{U}\left[ min\_taux\_prelevement\_zp\_ps , max\_taux\_prelevement\_zp\_ps \right]$ avec $min\_taux\_prelevement\_zp\_ps$ et $max\_taux\_prelevement\_zp\_ps$ valant 5\% et 25\%.
}.
À noter que les zones de prélèvement liées à des châteaux suivent une règle légèrement différente, que nous n'aborderons pas ici\footnote{Se référer au code-source du modèle, dans la fonction \textsf{construction\_chateaux}}.

Les prélèvements, selon les types de droits, rapportent de la \og puissance\fg{} aux seigneurs, dont le \cref{tab:puissance-droits} donne une référence.

\begin{table}[H]
	\centering
	{\renewcommand{\arraystretch}{1.1}%
		\begin{tabular}{|l|l|l|}\hline
			\textbf{Type de droit} & \textbf{Fonction du seigneur} & \textbf{\makecell{Puissance acquise\\par foyer paysan}} \\ \hline
			\multirow{2}{*}{Haute Justice} & Propriétaire ou Gardien & 2 \\
			& Souverain (zone donnée) & 2.5 \\ \hline
			\multirow{2}{*}{Droits fonciers} & Propriétaire ou Gardien & 1 \\
			& Souverain (zone donnée) & 1.25 \\ \hline
			\multirow{2}{*}{Autres droits} & Propriétaire ou Gardien & 0.25 \\
			& Souverain (zone donnée) & 0.35 \\ \hline	
	\end{tabular}}
\caption{Gain de puissance par foyer paysan prélevé.}
\label{tab:puissance-droits}
\end{table}


\paragraph{Foncier}

Quelques petits seigneurs (ceux créés dès l'initialisation ainsi que $\approx 10\%$ de ceux créés pendant le déroulement de la simulation) possèdent des droits fonciers.
À ce titre, ils peuvent collecter ces droits au sein d'une zone de prélèvement qu'ils créent lors de leur apparition.
Le mécanisme de collecte des droits fonciers est illustré dans la \cref{fig:prelevement-fonciers}.
\begin{figure}[H]
	\centering
	\includegraphics[width=0.8\linewidth]{img/prelevements_foncier.pdf}
	\caption{Prélèvement des droits fonciers par les petits et grands seigneurs.}
	\label{fig:prelevement-fonciers}
\end{figure}

\paragraph{Haute justice et autres droits}

Les autres droits suivent un mécanisme plus générique : les seigneurs propriétaires collectent des droits auprès d'une partie des foyers paysans inclus dans la surface de la zone de prélèvement.
Cette partie correspond aux \og taux de prélèvement\fg{} décrit plus haut. La \cref{fig:prelevement-droits} récapitule les différentes modalités de collecte de droits via les zones de prélèvement.

\begin{figure}[H]
	\centering
	\includegraphics[width=\linewidth]{img/prelevements_droits.pdf}
	\caption{Mécanisme général de prélèvement des droits par les seigneurs.}
	\label{fig:prelevement-droits}
\end{figure}

Les droits de haute justice sont prélevés exactement comme les autres droits, à la seule différence qu'ils correspondent nécessairement à des taux de prélèvement de 100\%.

\subsubsection{Construction de châteaux \label{sssec:constru-chateaux}}


À partir de 940, les seigneurs ont la possibilité de créer des châteaux, dans un espace limité par la présence d'autres châteaux : on considère ainsi, au regard des connaissances empiriques, que deux châteaux ne peuvent être espacés de moins de 5 000 mètres.
Le mécanisme de construction des châteaux est commun aux grands et aux petits seigneurs, mais certains paramètres varient selon le type du seigneur considéré :
\begin{itemize}
	\item Un grand seigneur peut construire jusqu'à $2$ châteaux par tour (paramètre $nb\_max\_chateaux\_par\_tour\_gs$), alors qu'un petit seigneur ne peut en construire au maximum que $1$ par pas de temps ($nb\_max\_chateaux\_par\_tour\_ps$).
	\item Pour un seigneur $i$, la probabilité de construire un château est formalisée ainsi :\\
	$$ P \left( construction \right) =  \frac{puissance\_seigneur_{i}}{\sum{puissance\_seigneur_{0..n}}} \times ponderation\_proba\_chateau $$ avec $ponderation\_proba\_chateau$ valant $1.25$ pour les grands seigneurs et $7$ pour les petits (paramètres techniques).
	\item Les grands seigneurs peuvent construire des châteaux n'importe-où dans l'espace du modèle (en respectant toutefois les règles exposées plus bas), alors que les petits seigneurs ne peuvent le faire que dans un rayon de 5 000 m de leur localisation : s'il n'y a pas d'espace disponible dans ce rayon, le petit seigneur ne crée pas de château.
\end{itemize}

Les règles de localisation de château sont identiques, et illustrés dans la \cref{fig:construction-chateaux}.

\begin{figure}[H]
	\centering
	\includegraphics[width=\linewidth]{img/construction_chateaux.pdf}
	\caption{Mécanisme de localisation des châteaux construits.}
	\label{fig:construction-chateaux}
\end{figure}

\paragraph{Rayon des zones de prélèvement associées}

La construction d'un château implique systématiquement la création de zones de prélèvements qui lui sont associées, c'est-à-dire qu'elles appartiennent au seigneur qui crée le château.
Si le château est donné en gardiennage, l'ensemble des zones de prélèvement qui lui sont associées seront aussi données en gardiennage au petit seigneur choisi.

Les zones de prélèvement créées concernent des droits fonciers et des autres droits.
Si le seigneur châtelain obtient les droits de haute justice, une zone de prélèvement de droits de haute justice sera automatiquement créée autour de chacun de ses châteaux.
Contrairement aux zones de prélèvement habituelles, celles qui sont associées à un château ont un taux de prélèvement de $100\%$.
Leur rayon est variable et dépend de la puissance relative du seigneur qui construit le château.
Ce rayon varie entre un seuil minimal de 2 000 m ($rayon\_min\_zp\_chateau$) et un seuil maximal de 15 000 m ($rayon\_max\_zp\_chateau$).
Entre ces deux seuils, la valeur du rayon dépend d'une fonction linéaire correspondant au ratio entre la puissance du seigneur constructeur et les puissances maximales et minimales de l'ensemble des seigneurs, tel que formalisé dans l'équation \ref{eq:rayon-zp-chateau}. 

\begin{equation}\label{eq:rayon-zp-chateau}
\begin{aligned}
& rayon\_zp\_chateau = \\
& min  \left[ max \left[ puissance\_relative; rayon\_min\_zp\_chateau \right]  ; rayon\_max\_zp\_chateau \right]
\\
& \text{avec}
\\
& puissance\_relative_i = \frac{max(puissance_{0..n}) - puissance_i}{max(puissance_{0..n}) \times min(puissance_{0..n})}
\end{aligned}
\end{equation}

\section*{Conclusion}
\addcontentsline{toc}{section}{Conclusion}

\hl{À rédiger}

\begin{itemize}
	\item Reprise processus de modélisation exploratoire.
	\item -> Nombreux changements, étalé sur un temps semi-long (+ 5 ans (21/04/2014) depuis le premier commit, qui donnait déjà une première version fonctionnelle du modèle), travail commencé avec moi en réunion en mars 2013, pour le séminaire TMD de Sommières de Juin 2013, soit avant le début de cette thèse. 
	\item -> Hétérogénéité forte dans le niveau de détail des mécanismes
	\item Description ni complète, ni trop schématisée : une tentative de juste milieu, qui respecte le niveau de détail de chacun des mécanismes.
\end{itemize}
